# Bale Inventory - Project Context

## Business Context

### Target Market
**Indian Textile Traders** - Small to medium-sized fabric trading businesses that:
- Buy fabric rolls from mills or suppliers
- Store inventory across multiple warehouses
- Sell to retailers, tailors, and manufacturers
- Need to track stock movement and orders
- Require barcode-based inventory management

### User Personas

**1. Business Owner / Admin**
- Manages overall company operations
- Has multiple warehouses
- Needs visibility across all locations
- Makes strategic decisions based on inventory reports
- Manages staff and permissions

**2. Warehouse Manager / Staff**
- Manages day-to-day warehouse operations
- Records goods receipts and dispatches
- Fulfills sales orders
- Scans barcodes for tracking
- Limited access to assigned warehouse only

**3. Customer (Public Catalog User)**
- Browses available fabrics
- Checks prices and availability
- Places orders online
- Tracks order status

### Business Workflows

#### 1. Procurement (Goods Receipt)
```
Supplier sends fabric â†’ Warehouse receives â†’ Create Goods Receipt
â†’ System creates Stock Units â†’ Stock available for sale
```

#### 2. Sales Order Fulfillment
```
Customer places order â†’ Admin/Staff reviews â†’ Approve order
â†’ Reserve stock units â†’ Create Goods Dispatch â†’ Mark order complete
```

#### 3. Job Work (Outsourcing)
```
Need processing (dyeing/printing) â†’ Create Job Work
â†’ Dispatch raw material to vendor â†’ Vendor processes
â†’ Receive finished goods â†’ Update inventory
```

#### 4. Warehouse Transfer
```
Stock needed in Warehouse B â†’ Create transfer dispatch from Warehouse A
â†’ Create receipt in Warehouse B â†’ Stock moved
```

## Technical Context

### Architecture Decisions

**Why Next.js?**
- Server-side rendering for better SEO (public catalog)
- App Router for clean file-based routing
- API routes for server-side operations
- Built-in optimization (images, fonts, code splitting)

**Why Supabase?**
- PostgreSQL with Row Level Security (RLS) for multi-tenancy
- Built-in authentication with JWT
- Real-time subscriptions (future enhancement)
- Storage for images
- Free tier sufficient for initial deployment

**Why Multi-Tenancy with RLS?**
- Complete data isolation between companies
- Security enforced at database level
- No risk of data leaks in application code
- Simplified permission logic

**Why Hostinger?**
- Cost-effective for Indian market
- Supports Node.js applications
- Easy deployment for small businesses
- Good uptime and support

### Database Design Philosophy

**Normalized Structure**
- Separate tables for each entity
- Foreign key relationships for data integrity
- Avoid duplication

**Audit Fields**
- Every table has: `created_at`, `updated_at`, `created_by`, `modified_by`
- Soft deletes with `deleted_at` for history
- Track who made changes for accountability

**Invite System Tables**
- `invites` table with two types: `platform` and `staff`
- Platform invites: No company_id (creates new company on acceptance)
- Staff invites: Has company_id and warehouse_id (joins existing company)
- Invite statuses: `pending`, `accepted`, `expired`, `revoked`
- 48-hour expiration by default
- 12-character alphanumeric codes (unique)

**Fabric-Specific Fields**
- `fabric_type`: Cotton, Polyester, Silk, Blend, etc.
- `gsm`: Grams per square meter (fabric weight)
- `color`: Name + hex code for accurate representation
- `measuring_unit`: Meters, yards, pieces, kg (different measurement systems)
- `quality_grade`: A, B, C, D (quality classification)

**Status-Driven Workflows**
- Stock Units: `in_stock` â†’ `reserved` â†’ `dispatched` â†’ `sold`
- Sales Orders: `draft` â†’ `approval_pending` â†’ `in_progress` â†’ `completed`/`cancelled`
- Dispatches: `pending` â†’ `in_transit` â†’ `delivered`/`cancelled`

### Security Model

**Row Level Security (RLS)**
Every query automatically filtered by:
1. **Company ID**: User can only see data from their company
2. **Warehouse ID**: Staff users limited to assigned warehouse
3. **Role**: Admin bypasses warehouse restrictions

**Example RLS Policy** (Stock Units):
```sql
-- Staff can only see stock in their assigned warehouse
CREATE POLICY "staff_access" ON stock_units
FOR SELECT
USING (
  company_id = auth.get_company_id()
  AND (
    auth.get_user_role() = 'admin'
    OR warehouse_id = auth.get_user_warehouse()
  )
);
```

**Authentication Flow**:
1. User logs in with email/password **OR** Google OAuth
2. Supabase Auth creates JWT token
3. JWT contains `auth_user_id`
4. Database functions look up user's `company_id`, `role`, `warehouse_id`
5. RLS policies enforce access control

**Invite System Flow**:
1. **Platform Invite** (for new companies):
   - Super admin creates platform invite for an email
   - User receives 12-character invite code
   - User signs up with invite code
   - System validates invite and creates company + user + warehouse

2. **Staff Invite** (for existing companies):
   - Admin creates staff invite for warehouse and role
   - Staff receives invite code
   - Staff signs up with invite code
   - System validates invite and creates user under existing company

### State Management

**Server Components (Default)**
- Dashboard pages fetch data on server
- No client-side state needed
- Automatic re-fetching on navigation
- Better performance and SEO

**Client Components (When Needed)**
- Forms with user interaction
- Navigation with active states
- Modals and dialogs
- Barcode scanning

**Data Fetching Pattern**:
```typescript
// Server component
export default async function ProductsPage() {
  const supabase = await createClient(); // Server client
  const { data } = await supabase.from('products').select('*');
  return <ProductsList products={data} />;
}

// Client component
'use client';
export default function ProductForm() {
  const supabase = createClient(); // Browser client
  const handleSubmit = async () => {
    await supabase.from('products').insert({...});
  };
}
```

## Development Context

### Current Status (January 2025)

**Completed**:
- âœ… Project initialization
- âœ… Database schema and migrations (17 total)
- âœ… Authentication system (email/password + Google OAuth)
- âœ… Invite system (platform and staff invites)
- âœ… Dashboard layout
- âœ… Deployment guide
- âœ… Google OAuth setup guide
- âœ… Invite system setup guide
- âœ… Context documentation updates

**In Progress**:
- ðŸš§ Products management page

**Next Steps**:
1. Configure Google OAuth in Supabase Studio
2. Test invite system end-to-end
3. Complete products CRUD
4. Build inventory management
5. Implement sales orders
6. Add partners management

### Tech Stack Versions
- Next.js: 15.1.4
- React: 19.x
- TypeScript: 5.x
- Tailwind CSS: 3.x
- Supabase: 2.75.0
- Node.js: 18+ (for deployment)

### Development Environment
- **OS**: Windows
- **Editor**: VS Code (assumed)
- **Database**: Supabase local (Docker)
- **Git**: GitHub repository
- **Package Manager**: npm

### Deployment Context

**Local Development**:
- Next.js dev server: http://localhost:3000
- Supabase Studio: http://localhost:54323
- Supabase API: http://localhost:54321

**Production**:
- Hosting: Hostinger (Node.js)
- Database: Supabase Cloud
- Process Manager: PM2
- SSL: Let's Encrypt (via Hostinger)

## Domain Knowledge

### Textile Industry Terms

**Fabric Types**:
- **Cotton**: Natural fiber, breathable
- **Polyester**: Synthetic, durable
- **Silk**: Luxury natural fiber
- **Blend**: Mix of fibers (e.g., poly-cotton)

**Measurements**:
- **GSM**: Grams per Square Meter (fabric weight/thickness)
- **Meters/Yards**: Length measurement
- **Pieces**: Individual fabric cuts
- **Kg**: Weight for some fabric types

**Quality Grades**:
- **Grade A**: First quality (export quality)
- **Grade B**: Second quality (slight defects)
- **Grade C**: Third quality (more defects)
- **Grade D**: Reject quality (major defects)

**Processing Types** (Job Works):
- **Dyeing**: Coloring fabric
- **Printing**: Patterns on fabric
- **Embroidery**: Decorative stitching
- **Washing**: Finishing process

### Business Terms

**Partners**:
- **Customer**: Buys fabric from you
- **Supplier**: Sells raw fabric to you
- **Vendor**: Provides services (dyeing, printing)
- **Agent**: Commission-based sales representative

**Stock Movement**:
- **Goods Receipt**: Incoming inventory
- **Goods Dispatch**: Outgoing inventory
- **Transfer**: Moving between own warehouses
- **Return**: Customer returning goods

**Order Types**:
- **Sales Order**: Customer order
- **Purchase Order**: Your order to supplier (not yet implemented)
- **Job Work Order**: Outsourcing order

## Project Conventions

### Naming Conventions

**Files**:
- Components: PascalCase (e.g., `ProductsList.tsx`)
- Pages: kebab-case (e.g., `sales-orders/page.tsx`)
- Utilities: camelCase (e.g., `formatDate.ts`)

**Database**:
- Tables: plural snake_case (e.g., `stock_units`)
- Columns: snake_case (e.g., `created_at`)
- Foreign keys: `{table}_id` (e.g., `company_id`)

**Code**:
- Types: PascalCase (e.g., `Product`, `StockUnit`)
- Functions: camelCase (e.g., `fetchProducts`)
- Constants: UPPER_SNAKE_CASE (e.g., `MAX_FILE_SIZE`)

### Git Commit Messages
- `feat:` - New feature
- `fix:` - Bug fix
- `docs:` - Documentation changes
- `refactor:` - Code refactoring
- `test:` - Adding tests
- `chore:` - Maintenance tasks

Example: `feat: Add products management page`

### Code Organization

**Component Structure**:
```typescript
// 1. Imports
import { createClient } from '@/lib/supabase/server';

// 2. Types
interface Props {
  // ...
}

// 3. Component
export default async function Component({ props }: Props) {
  // 4. Data fetching
  const data = await fetchData();

  // 5. Return JSX
  return <div>{/* ... */}</div>;
}
```

**API Route Structure**:
```typescript
import { createClient } from '@/lib/supabase/server';
import { NextRequest, NextResponse } from 'next/server';

export async function GET(request: NextRequest) {
  const supabase = await createClient();
  // Logic
  return NextResponse.json({ data });
}
```

## Pain Points & Solutions

### Common Issues

**Issue**: Supabase not starting
- **Solution**: Check Docker is running, restart Docker Desktop

**Issue**: Migration circular dependency
- **Solution**: Make foreign keys nullable or split migrations

**Issue**: RLS blocking queries
- **Solution**: Check user has correct `company_id` and `warehouse_id`

**Issue**: Type errors with Supabase queries
- **Solution**: Generate types: `npx supabase gen types typescript --local`

**Issue**: 401 Unauthorized errors
- **Solution**: Check JWT token is valid, user is logged in

### Best Practices

**1. Always use RLS**: Never bypass RLS policies in application code

**2. Server components by default**: Only use `'use client'` when necessary

**3. Type everything**: Use TypeScript strictly, avoid `any`

**4. Handle errors gracefully**: Show user-friendly error messages

**5. Validate inputs**: Use Zod schemas for form validation

**6. Audit changes**: Always set `created_by` and `modified_by`

**7. Test multi-tenancy**: Always test with multiple companies

**8. Test permissions**: Test both admin and staff user flows

## Key Relationships

### Entity Relationships

```
Company (1) ----< Users (N)
Company (1) ----< Warehouses (N)
Company (1) ----< Products (N)
Company (1) ----< Partners (N)
Company (1) ----< Invites (N) [staff invites only]

Warehouse (1) ----< Stock Units (N)
Warehouse (1) ----< Invites (N) [staff invites only]
Product (1) ----< Stock Units (N)

Sales Order (1) ----< Sales Order Items (N)
Sales Order Item (N) ----> Product (1)

Goods Receipt (1) ----< Stock Units (N)
Goods Dispatch (N) ----> Stock Units (1)

User (1) ----< Goods Receipts (N) [created_by]
User (1) ----< Goods Dispatches (N) [created_by]
User (1) ----< Invites (N) [invited_by]

Invite (N) ----> Company (0-1) [null for platform invites]
Invite (N) ----> Warehouse (0-1) [null for platform invites]
```

### Permission Inheritance

```
Platform (Super Admin)
â”œâ”€â”€ Can create platform invites
â”œâ”€â”€ Can view all companies (future admin panel)
â””â”€â”€ Manages platform-level settings

Company
â”œâ”€â”€ Admin User (access to ALL company warehouses)
â”‚   â”œâ”€â”€ Can create staff invites
â”‚   â”œâ”€â”€ Can manage warehouses
â”‚   â””â”€â”€ Can view all company data
â””â”€â”€ Staff User (access to ASSIGNED warehouse only)
    â”œâ”€â”€ Can only see/edit data in their warehouse
    â””â”€â”€ Cannot create invites or manage settings
```

## Future Considerations

### Scalability
- Consider API rate limiting
- Implement caching for frequently accessed data
- Optimize database queries with indexes
- Consider CDN for static assets

### Features to Add
- Real-time notifications (Supabase Realtime)
- Advanced reporting (charts, graphs)
- Export functionality (PDF, Excel)
- Email notifications for orders
- SMS updates for customers
- Multi-language support (Hindi, Gujarati, etc.)

### Technical Debt
- Add comprehensive error handling
- Implement logging system
- Add monitoring and alerting
- Create backup strategy
- Document API endpoints

---

**Last Updated**: January 2025
**Project Status**: Active Development - Phase 5 (Products Management)
