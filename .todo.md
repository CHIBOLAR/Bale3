# Bale Inventory App Refactor - Task List

## Legend
- ‚úÖ Completed
- ‚è≥ In Progress
- ‚è∏Ô∏è Blocked/Waiting
- ‚ùå Cancelled
- üîÑ Needs Review
- ‚≠ï Not Started

---

## Phase 1: Authentication System Overhaul ‚úÖ COMPLETED

### 1.1 Delete Demo System Files ‚úÖ
- ‚úÖ Delete `app/actions/auth/demo-login.ts`
- ‚úÖ Delete `app/api/create-demo-account/route.ts`
- ‚úÖ Delete `lib/utils/demo-restrictions.ts`
- ‚úÖ Delete `scripts/seed-demo-data.ts`
- ‚úÖ Delete `components/DemoBanner.tsx`
- ‚úÖ Delete `app/dashboard/request-upgrade/` directory
- ‚úÖ Delete `app/api/upgrade-account/` directory
- ‚úÖ Delete `app/api/admin/approve-upgrade/` directory
- ‚úÖ Delete `app/api/admin/reject-upgrade/` directory
- ‚úÖ Delete `app/dashboard/admin/upgrade-requests/` directory

### 1.2 Delete Invite System Files ‚è∏Ô∏è
- ‚è∏Ô∏è Delete `app/api/request-invite/` directory (not found)
- ‚è∏Ô∏è Delete `app/api/admin/approve-invite/` directory (not found)
- ‚è∏Ô∏è Delete `app/api/admin/reject-invite/` directory (not found)
- ‚è∏Ô∏è Delete `app/dashboard/admin/invites/` directory (not found)
- ‚è∏Ô∏è Find and delete `app/components/TryDemoButton.tsx` (not found)

### 1.3 Configure Google OAuth ‚úÖ
- ‚úÖ Set up Google OAuth in Google Cloud Console
- ‚úÖ Configure OAuth consent screen
- ‚úÖ Get Client ID and Client Secret
- ‚úÖ Add OAuth provider in Supabase dashboard
- ‚úÖ Configure redirect URLs (production: https://xejyeglxigdeznfitaxc.supabase.co/auth/v1/callback)
- ‚úÖ Add environment variables to `.env.local`
- ‚úÖ Add environment variables to Vercel

### 1.4 Create New Authentication Files ‚úÖ
- ‚úÖ Create `app/(auth)/auth/callback/route.ts` - OAuth callback handler
- ‚úÖ Create `lib/auth/providers.ts` - Auth provider utilities (Google OAuth + Email OTP)
- ‚úÖ Create `app/actions/auth/setup-new-user.ts` - Auto-setup for new users
- ‚úÖ Create `app/api/auth/setup/route.ts` - Setup API endpoint

### 1.5 Rewrite Authentication Pages ‚úÖ
- ‚úÖ Delete `app/(auth)/signup/page.tsx` - Removed entirely (unified login)
- ‚úÖ Rewrite `app/(auth)/login/page.tsx`
  - ‚úÖ Add "Continue with Google" button (primary)
  - ‚úÖ Add "Sign in with Email OTP" button (secondary)
  - ‚úÖ Unified login/signup experience
  - ‚úÖ Add proper error handling
  - ‚úÖ Add loading states
  - ‚úÖ Improved UI with better styling, shadows, and professional design
  - ‚úÖ Auto-account creation for new users

### 1.6 Auto-Setup System (No Onboarding Wizard) ‚úÖ
- ‚úÖ Created `app/actions/auth/setup-new-user.ts` for automatic setup
- ‚úÖ Auto-creates company on first login (name: "FirstName's Company")
- ‚úÖ Auto-creates user record with admin role
- ‚úÖ Auto-creates default "Main Warehouse"
- ‚úÖ Sets `onboarding_completed` to true automatically
- ‚úÖ Redirects to dashboard after successful login
- ‚ùå No manual onboarding wizard needed

### 1.7 Update Middleware ‚è≥
- ‚è≥ Open `middleware.ts`
- ‚è≥ Remove all demo-related checks
- ‚è≥ Remove invite code validation
- ‚è≥ Simplify to basic auth checks
- ‚è≥ Add onboarding redirect logic (if needed)
- ‚è≥ Test middleware with new auth flow

### 1.8 Database Migrations ‚úÖ
- ‚úÖ `make_phone_number_nullable` - Made phone_number nullable for OAuth/OTP signup
- ‚úÖ `add_is_demo_column_to_users` - Added is_demo column (legacy compatibility)
- ‚è≥ Create comprehensive demo system cleanup migration (future task)

### 1.9 Update Landing Page ‚úÖ
- ‚úÖ Update `app/page.tsx`
- ‚úÖ Remove duplicate buttons (had both "Login" and "Sign In")
- ‚úÖ Kept single "Sign In" button
- ‚úÖ All signup links now point to unified `/login` page
- ‚úÖ Test responsive design

### 1.10 Testing ‚úÖ
- ‚úÖ Test Google OAuth signup flow - Working
- ‚úÖ Test Email OTP signup flow - Working
- ‚úÖ Test Google login flow - Working
- ‚úÖ Test Email OTP login flow - Working
- ‚úÖ Test auto-setup (company/user/warehouse creation) - Working
- ‚úÖ Test session persistence - Working
- ‚úÖ Test redirect to dashboard - Working
- ‚è≥ Test logout functionality
- ‚è≥ Test middleware redirects
- ‚è≥ Test mobile auth flows

---

## Phase 2: Performance Optimization

### 2.1 Create Database Indexes
- ‚è≥ Create `supabase/migrations/YYYYMMDDHHMMSS_add_performance_indexes.sql`
- ‚è≥ Add index on `products(company_id)`
- ‚è≥ Add index on `stock_units(company_id, warehouse_id)`
- ‚è≥ Add index on `stock_units(status)`
- ‚è≥ Add index on `goods_receipts(company_id, created_at DESC)`
- ‚è≥ Add index on `goods_dispatch(company_id, created_at DESC)`
- ‚è≥ Add index on `partners(company_id, partner_type)`
- ‚è≥ Add index on `sales_orders(company_id, status)`
- ‚è≥ Add composite index on `stock_units(product_id, warehouse_id, status)`
- ‚è≥ Test migration locally
- ‚è≥ Run migration in production

### 2.2 Implement Pagination System
- ‚è≥ Create `lib/pagination/config.ts` - Default page sizes, limits
- ‚è≥ Create `lib/pagination/utils.ts` - Pagination helper functions
- ‚è≥ Create `components/Pagination.tsx` - Reusable pagination component
  - Page number display
  - Previous/Next buttons
  - Items per page selector
  - Total count display
  - Jump to page input
- ‚è≥ Add URL search params handling for pagination
- ‚è≥ Test pagination component

### 2.3 Create Loading Components
- ‚è≥ Create `components/loading/SkeletonCard.tsx`
- ‚è≥ Create `components/loading/SkeletonTable.tsx`
- ‚è≥ Create `components/loading/SkeletonList.tsx`
- ‚è≥ Create `components/loading/PageLoader.tsx`
- ‚è≥ Create `components/loading/SpinnerButton.tsx`

### 2.4 Optimize Dashboard
- ‚è≥ Update `app/dashboard/page.tsx`
  - Add proper Suspense boundaries
  - Limit recent activities to 10 items
  - Use summary stats (not full datasets)
  - Implement parallel data fetching
  - Add loading skeletons
- ‚è≥ Update `app/actions/dashboard/data.ts`
  - Add query limits to functions
  - Optimize database queries
  - Select only needed columns
  - Add error handling
- ‚è≥ Test dashboard load time (target: < 1.5s)

### 2.5 Optimize Products List Page
- ‚è≥ Update `app/dashboard/products/page.tsx`
  - Add pagination with URL params
  - Add search functionality
  - Add filter dropdowns
  - Add sort options
  - Add loading skeleton
  - Select only needed columns
- ‚è≥ Update products query function
- ‚è≥ Test with large dataset (100+ products)
- ‚è≥ Verify load time < 1s

### 2.6 Optimize Stock Units Page
- ‚è≥ Update `app/dashboard/inventory/stock-units/page.tsx`
  - Add pagination
  - Add search by product/QR code
  - Add status filter
  - Add warehouse filter
  - Add date range filter
  - Add loading skeleton
- ‚è≥ Optimize stock units query
- ‚è≥ Test with large dataset (500+ units)

### 2.7 Optimize Goods Receipts Page
- ‚è≥ Update `app/dashboard/inventory/goods-receipts/page.tsx`
  - Add pagination
  - Add search by receipt number
  - Add date range filter
  - Add source type filter
  - Add loading skeleton
- ‚è≥ Optimize goods receipts query
- ‚è≥ Test with large dataset

### 2.8 Optimize Goods Dispatch Page
- ‚è≥ Update `app/dashboard/inventory/goods-dispatch/page.tsx`
  - Add pagination
  - Add search by dispatch number
  - Add date range filter
  - Add status filter
  - Add loading skeleton
- ‚è≥ Optimize goods dispatch query
- ‚è≥ Test with large dataset

### 2.9 Optimize Partners Page
- ‚è≥ Update `app/dashboard/partners/page.tsx`
  - Add pagination
  - Add search by name
  - Add partner type filter
  - Add loading skeleton
- ‚è≥ Optimize partners query
- ‚è≥ Test with large dataset

### 2.10 Optimize Sales Orders Page
- ‚è≥ Update `app/dashboard/sales-orders/page.tsx`
  - Add pagination
  - Add search by order number
  - Add date range filter
  - Add status filter
  - Add loading skeleton
- ‚è≥ Optimize sales orders query
- ‚è≥ Test with large dataset

### 2.11 Set Up React Query
- ‚è≥ Install `@tanstack/react-query`
- ‚è≥ Create `lib/react-query/provider.tsx`
- ‚è≥ Configure QueryClient with proper defaults
- ‚è≥ Create `lib/react-query/hooks.ts` - Custom hooks
- ‚è≥ Add QueryClientProvider to root layout
- ‚è≥ Implement cache invalidation strategy
- ‚è≥ Add optimistic updates for mutations

### 2.12 Image Optimization
- ‚è≥ Update `next.config.js` with image domains
- ‚è≥ Replace `<img>` tags with Next.js `<Image>` in:
  - Product images
  - Company logos
  - User avatars
  - Landing page images
- ‚è≥ Set up proper image formats (webp, avif)
- ‚è≥ Add responsive image sizes

### 2.13 Performance Testing
- ‚è≥ Measure dashboard load time
- ‚è≥ Measure list pages load time
- ‚è≥ Check Core Web Vitals
- ‚è≥ Test with large datasets
- ‚è≥ Test on slow 3G network
- ‚è≥ Test on mobile devices
- ‚è≥ Verify all targets met

---

## Phase 3: Goods Receipt Standardization

### 3.1 Define Standard Data Structure
- ‚è≥ Create `lib/types/goods-receipt.ts`
- ‚è≥ Define `StandardGoodsReceiptDisplay` interface
- ‚è≥ Define `GoodsReceiptListItem` interface
- ‚è≥ Define `GoodsReceiptDetailView` interface
- ‚è≥ Define transformation functions

### 3.2 Create Standard Components
- ‚è≥ Create `components/inventory/GoodsReceiptCard.tsx`
  - Receipt number
  - Date display
  - Supplier info
  - Items count
  - Total quantity
  - Status badge
  - Quick actions
- ‚è≥ Create `components/inventory/GoodsReceiptListItem.tsx`
  - Table row format
  - Consistent columns
  - Responsive design
- ‚è≥ Create `components/inventory/GoodsReceiptDetail.tsx`
  - Full receipt details
  - Item list with specs
  - Stock units created section
  - Timeline
  - Print button
  - Edit button

### 3.3 Create Centralized Queries
- ‚è≥ Create `lib/queries/goods-receipts.ts`
- ‚è≥ Implement `getGoodsReceipt(id)` with standard JOIN
- ‚è≥ Implement `getGoodsReceipts(companyId, options)` with pagination
- ‚è≥ Implement data transformation functions
- ‚è≥ Ensure consistent date formatting
- ‚è≥ Ensure consistent number formatting

### 3.4 Refactor Goods Receipts List Page
- ‚è≥ Update `app/dashboard/inventory/goods-receipts/page.tsx`
- ‚è≥ Use GoodsReceiptCard or GoodsReceiptListItem
- ‚è≥ Use centralized query functions
- ‚è≥ Ensure consistent display
- ‚è≥ Test with old and new receipts

### 3.5 Refactor Goods Receipt Detail Page
- ‚è≥ Update `app/dashboard/inventory/goods-receipts/[id]/page.tsx`
- ‚è≥ Use GoodsReceiptDetail component
- ‚è≥ Use centralized query
- ‚è≥ Ensure consistent display
- ‚è≥ Test with various receipt types

### 3.6 Refactor Goods Receipt Creation
- ‚è≥ Update `app/dashboard/inventory/goods-receipts/new/page.tsx`
- ‚è≥ Ensure creates standard format
- ‚è≥ Update form validation
- ‚è≥ Update server action
- ‚è≥ Test creation flow

### 3.7 Update Server Actions
- ‚è≥ Update `app/actions/inventory/goods-receipts.ts`
- ‚è≥ Use centralized queries
- ‚è≥ Ensure standard data format
- ‚è≥ Add proper error handling

### 3.8 Testing
- ‚è≥ Test goods receipt list display
- ‚è≥ Test goods receipt detail display
- ‚è≥ Test goods receipt creation
- ‚è≥ Verify consistency across all views
- ‚è≥ Test with different source types
- ‚è≥ Test print functionality

---

## Phase 4: UI/UX Improvements

### 4.1 Redesign Landing Page
- ‚è≥ Complete rewrite of `app/page.tsx`
- ‚è≥ New hero section with clear value proposition
- ‚è≥ Update CTAs (Google OAuth + Email OTP)
- ‚è≥ Remove all demo content
- ‚è≥ Add feature showcase
- ‚è≥ Add testimonials (optional)
- ‚è≥ Add pricing section (optional)
- ‚è≥ Update footer
- ‚è≥ Test responsive design
- ‚è≥ Test all links

### 4.2 Remove Demo UI Elements
- ‚è≥ Search codebase for "demo" (case-insensitive)
- ‚è≥ Remove from `app/dashboard/layout.tsx`
- ‚è≥ Remove from all feature pages
- ‚è≥ Remove "Demo Mode" badges
- ‚è≥ Remove "Upgrade Account" buttons
- ‚è≥ Remove demo restrictions display
- ‚è≥ Remove account type indicators
- ‚è≥ Remove demo limits display (e.g., "3/5 products")

### 4.3 Improve Dashboard Navigation
- ‚è≥ Update `components/DashboardNav.tsx`
- ‚è≥ Group menu items logically
- ‚è≥ Add icons to all items (if missing)
- ‚è≥ Improve active state indication
- ‚è≥ Improve mobile menu
- ‚è≥ Add keyboard shortcuts (optional)
- ‚è≥ Test navigation on mobile

### 4.4 Add Breadcrumbs
- ‚è≥ Create `components/Breadcrumbs.tsx`
- ‚è≥ Implement dynamic breadcrumb logic
- ‚è≥ Add to `app/dashboard/layout.tsx`
- ‚è≥ Test on various pages
- ‚è≥ Test on mobile

### 4.5 Improve Loading States
- ‚è≥ Add loading skeletons to dashboard
- ‚è≥ Add loading skeletons to all list pages
- ‚è≥ Add loading skeletons to detail pages
- ‚è≥ Add loading spinners to forms
- ‚è≥ Add loading states to buttons
- ‚è≥ Test all loading states

### 4.6 Improve Mobile Responsiveness
- ‚è≥ Test all pages on mobile
- ‚è≥ Fix any layout issues
- ‚è≥ Improve table responsiveness
- ‚è≥ Improve form responsiveness
- ‚è≥ Test on various screen sizes

---

## Phase 5: Backend Cleanup

### 5.1 Remove Demo Logic from Server Actions
- ‚è≥ Search for `is_demo` in codebase
- ‚è≥ Search for `isDemoUser` in codebase
- ‚è≥ Search for `checkDemoRestriction` in codebase
- ‚è≥ Remove demo checks from:
  - `app/actions/products/*.ts`
  - `app/actions/inventory/*.ts`
  - `app/actions/partners/*.ts`
  - `app/actions/sales/*.ts`
  - `app/actions/warehouse/*.ts`
  - `app/actions/staff/*.ts`

### 5.2 Remove Demo Constants
- ‚è≥ Search for `MAX_PRODUCTS`
- ‚è≥ Search for `MAX_PARTNERS`
- ‚è≥ Search for `MAX_SALES_ORDERS`
- ‚è≥ Search for `MAX_GOODS_RECEIPTS`
- ‚è≥ Search for `MAX_GOODS_DISPATCHES`
- ‚è≥ Remove all demo restriction constants

### 5.3 Clean Up API Routes
- ‚è≥ Review all API routes in `app/api/`
- ‚è≥ Remove demo-related logic
- ‚è≥ Remove invite-related routes (already deleted)
- ‚è≥ Remove upgrade-related routes (already deleted)
- ‚è≥ Add proper error handling
- ‚è≥ Add proper logging

### 5.4 Consolidate Duplicate Code
- ‚è≥ Identify common patterns
- ‚è≥ Extract form validation to `lib/validation/`
- ‚è≥ Extract data formatting to `lib/formatters/`
- ‚è≥ Extract common queries to `lib/queries/`
- ‚è≥ Extract reusable hooks to `lib/hooks/`

### 5.5 TypeScript Improvements
- ‚è≥ Generate types from Supabase schema
- ‚è≥ Create `lib/types/database.ts`
- ‚è≥ Create `lib/types/api.ts`
- ‚è≥ Create `lib/types/forms.ts`
- ‚è≥ Fix all `any` types
- ‚è≥ Add proper type exports
- ‚è≥ Run TypeScript compiler, fix errors

### 5.6 Error Handling
- ‚è≥ Create `lib/errors/handler.ts`
- ‚è≥ Create `lib/errors/types.ts`
- ‚è≥ Standardize error messages
- ‚è≥ Add error logging
- ‚è≥ Create error boundaries
- ‚è≥ Test error handling

### 5.7 Add Logging
- ‚è≥ Set up logging utility
- ‚è≥ Add logging to critical operations
- ‚è≥ Add performance logging
- ‚è≥ Add error logging
- ‚è≥ Test logging in production

---

## Phase 6: Testing & Validation

### 6.1 Authentication Testing
- ‚è≥ Test Google OAuth signup on desktop
- ‚è≥ Test Google OAuth signup on mobile
- ‚è≥ Test Email OTP signup on desktop
- ‚è≥ Test Email OTP signup on mobile
- ‚è≥ Test Google login on desktop
- ‚è≥ Test Google login on mobile
- ‚è≥ Test Email OTP login on desktop
- ‚è≥ Test Email OTP login on mobile
- ‚è≥ Test onboarding wizard
- ‚è≥ Test session persistence
- ‚è≥ Test logout functionality
- ‚è≥ Test auth redirects
- ‚è≥ Test protected routes

### 6.2 Performance Testing
- ‚è≥ Measure dashboard load time
- ‚è≥ Measure products page load time
- ‚è≥ Measure inventory pages load time
- ‚è≥ Measure partners page load time
- ‚è≥ Measure sales orders page load time
- ‚è≥ Test with 100+ products
- ‚è≥ Test with 500+ stock units
- ‚è≥ Test with 50+ goods receipts
- ‚è≥ Check Core Web Vitals (LCP, FID, CLS)
- ‚è≥ Test on slow 3G network
- ‚è≥ Test on various devices
- ‚è≥ Verify all performance targets met

### 6.3 Feature Testing
- ‚è≥ Test create product
- ‚è≥ Test edit product
- ‚è≥ Test delete product
- ‚è≥ Test create partner
- ‚è≥ Test edit partner
- ‚è≥ Test delete partner
- ‚è≥ Test create goods receipt
- ‚è≥ Test view goods receipt
- ‚è≥ Test create goods dispatch
- ‚è≥ Test view goods dispatch
- ‚è≥ Test create sales order
- ‚è≥ Test view sales order
- ‚è≥ Test QR code generation
- ‚è≥ Test QR code scanning
- ‚è≥ Test warehouse switching
- ‚è≥ Test staff management
- ‚è≥ Test all pagination
- ‚è≥ Test all search/filters
- ‚è≥ Test all sort options

### 6.4 UI/UX Testing
- ‚è≥ Test landing page on desktop
- ‚è≥ Test landing page on mobile
- ‚è≥ Test dashboard on desktop
- ‚è≥ Test dashboard on mobile
- ‚è≥ Test all pages on mobile
- ‚è≥ Test breadcrumbs
- ‚è≥ Test navigation
- ‚è≥ Test loading states
- ‚è≥ Test error states
- ‚è≥ Verify no demo UI elements remain

### 6.5 Database Testing
- ‚è≥ Verify migrations ran successfully
- ‚è≥ Verify indexes created
- ‚è≥ Verify demo tables dropped
- ‚è≥ Verify demo columns removed
- ‚è≥ Test RLS policies
- ‚è≥ Test multi-tenancy isolation
- ‚è≥ Test data integrity

### 6.6 Bug Fixes
- ‚è≥ Create list of bugs found
- ‚è≥ Prioritize bugs
- ‚è≥ Fix critical bugs
- ‚è≥ Fix high-priority bugs
- ‚è≥ Fix medium-priority bugs
- ‚è≥ Retest after fixes

### 6.7 Code Quality
- ‚è≥ Run TypeScript compiler
- ‚è≥ Fix all TypeScript errors
- ‚è≥ Run ESLint
- ‚è≥ Fix linting issues
- ‚è≥ Run Prettier
- ‚è≥ Format code
- ‚è≥ Review code for dead code
- ‚è≥ Remove unused imports
- ‚è≥ Remove commented code

---

## Phase 7: Documentation & Deployment

### 7.1 Update Documentation
- ‚è≥ Update README.md
- ‚è≥ Document new auth flow
- ‚è≥ Document environment variables
- ‚è≥ Document database schema changes
- ‚è≥ Document API changes
- ‚è≥ Create deployment guide
- ‚è≥ Create user guide (optional)

### 7.2 Pre-Deployment Checklist
- ‚è≥ Backup production database
- ‚è≥ Test migrations in staging
- ‚è≥ Update environment variables in Vercel
- ‚è≥ Verify Google OAuth credentials
- ‚è≥ Verify Resend API limits
- ‚è≥ Review security settings
- ‚è≥ Test rollback procedure
- ‚è≥ Prepare monitoring

### 7.3 Deployment
- ‚è≥ Create branch: `refactor/remove-demo-and-optimize`
- ‚è≥ Commit all changes
- ‚è≥ Push to GitHub
- ‚è≥ Create pull request
- ‚è≥ Review code changes
- ‚è≥ Deploy to Vercel preview
- ‚è≥ Test preview deployment thoroughly
- ‚è≥ Run migrations in production database
- ‚è≥ Merge to main
- ‚è≥ Deploy to production
- ‚è≥ Verify production deployment
- ‚è≥ Monitor for errors

### 7.4 Post-Deployment
- ‚è≥ Monitor application logs
- ‚è≥ Monitor error rates
- ‚è≥ Monitor performance metrics
- ‚è≥ Check user feedback
- ‚è≥ Fix any critical issues
- ‚è≥ Create issues for future improvements

---

## Notes & Blockers

### Current Blockers
- None

### Important Notes
- No demo users exist, full freedom to refactor
- App is live on Vercel, test thoroughly before deploying
- Backup database before running migrations
- Google OAuth requires domain verification
- Test on multiple devices and browsers

### Questions for User
- None currently

---

## Phase 7: Accounting Module Integration

### 7.1 Database Schema & Migrations (Week 1)

#### Create User-Facing Tables
- ‚≠ï Create `invoices` table
  - invoice_number, customer_id, dispatch_id (FK)
  - invoice_date, subtotal, gst_amount, total_amount
  - payment_status ('unpaid', 'partial', 'paid')
  - tally_import_id, tally_voucher_guid (for import tracking)
- ‚≠ï Create `payments_received` table
  - payment_number, customer_id, invoice_id (FK)
  - amount, payment_method, payment_date
  - bank_details (for cheque/bank transfer)
- ‚≠ï Create `purchase_bills` table
  - bill_number, supplier_id, receipt_id (FK)
  - bill_date, subtotal, gst_amount, total_amount
  - payment_status
- ‚≠ï Create `payments_made` table
  - payment_number, supplier_id, bill_id (FK)
  - amount, payment_method, payment_date
- ‚≠ï Create `expenses` table
  - expense_number, category, amount
  - payment_method, expense_date, description

#### Create Hidden Accounting Tables
- ‚≠ï Create `ledger_accounts` table
  - name, account_group_id (FK), account_type
  - current_balance, balance_type ('debit'/'credit')
  - partner_id (FK - for customer/supplier ledgers)
  - is_system_ledger (Cash, Bank, Sales, etc.)
- ‚≠ï Create `journal_entries` table
  - entry_number, transaction_type, transaction_id
  - entry_date, narration
  - imported_from_tally, tally_voucher_guid
- ‚≠ï Create `journal_entry_lines` table
  - journal_entry_id (FK), ledger_account_id (FK)
  - debit_amount, credit_amount
  - bill_reference (for bill-wise tracking)

#### Create Supporting Tables
- ‚≠ï Create `account_groups` table
  - name, parent_group_id (FK), group_type
  - nature ('Asset', 'Liability', 'Income', 'Expense')
  - is_system_group (28 standard Tally groups)
- ‚≠ï Create `gst_settings` table (per company)
  - gstin, state_code, default_gst_rate
  - e_invoice_enabled, e_invoice_username
- ‚≠ï Create `inventory_movements` table
  - journal_entry_id (FK), stock_unit_id (FK)
  - movement_type ('inward', 'outward')
  - quantity, unit, rate
- ‚≠ï Create `tally_import_logs` table
  - import_date, period_from, period_to
  - import_type, status, records_processed
- ‚≠ï Create `tally_export_queue` table
  - export_date, period_from, period_to
  - status, xml_file_url

#### Database Triggers & Functions
- ‚≠ï Create double-entry validation trigger
  - Enforces Dr = Cr before INSERT on journal_entry_lines
  - Raises exception if unbalanced
- ‚≠ï Create auto-ledger creation trigger
  - Auto-creates ledger when new partner created
  - Links partner to ledger_account
- ‚≠ï Create COGS calculation function (FIFO)
  - Calculates cost based on stock_units purchase_rate
  - Returns weighted average cost
- ‚≠ï Create ledger balance calculation function
  - Real-time balance from journal_entry_lines
  - Returns current balance + balance_type

#### Indexing & Performance
- ‚≠ï Add indexes on invoices(company_id, invoice_date)
- ‚≠ï Add indexes on journal_entries(company_id, entry_date)
- ‚≠ï Add indexes on journal_entry_lines(ledger_account_id)
- ‚≠ï Add indexes on ledger_accounts(partner_id)
- ‚≠ï Add indexes on payments_received(invoice_id)

#### Data Seeding
- ‚≠ï Seed 28 standard account groups
  - Assets: Current Assets, Fixed Assets, Bank Accounts, Cash, Stock, Sundry Debtors
  - Liabilities: Current Liabilities, Sundry Creditors, Duties & Taxes, Capital Account
  - Income: Sales, Direct Income, Indirect Income
  - Expense: Purchase, Direct Expenses, Indirect Expenses
- ‚≠ï Seed system ledgers for each company
  - Cash, Bank Account, Sales, Purchases
  - CGST Output, SGST Output, IGST Output
  - CGST Input, SGST Input, IGST Input
  - Cost of Goods Sold, Inventory

### 7.2 Core Accounting Engine (Week 2)

#### Double-Entry Logic
- ‚≠ï Create `createJournalEntry()` function
  - Accepts transaction_type, transaction_id, date, lines[]
  - Validates Dr = Cr before save
  - Auto-generates entry_number
- ‚≠ï Create `validateDoubleEntry()` function
  - Checks total Dr = total Cr
  - Returns validation errors
- ‚≠ï Create `reverseJournalEntry()` function
  - Creates opposite entry for cancellations
  - Links to original entry

#### Ledger Management
- ‚≠ï Create `getOrCreateLedger()` function
  - Finds existing ledger or creates new
  - Auto-assigns to correct account group
- ‚≠ï Create `calculateLedgerBalance()` function
  - Sums all Dr/Cr entries for ledger
  - Returns balance + balance_type
- ‚≠ï Create `getLedgerStatement()` function
  - Returns all transactions for ledger
  - With running balance

#### GST Calculator
- ‚≠ï Create `calculateGST()` function
  - Accepts: amount, customer_state, company_state, gst_rate
  - Returns: {cgst, sgst, igst, total_gst}
  - Logic: Same state ‚Üí CGST+SGST, Different state ‚Üí IGST
- ‚≠ï Create `getGSTRate()` function
  - Gets rate from hsn_code or default company rate

#### COGS Calculator
- ‚≠ï Create `calculateCOGS()` function (FIFO method)
  - Accepts: stock_units[] dispatched
  - Queries stock_units.purchase_rate in FIFO order
  - Returns: total_cost
- ‚≠ï Create `createCOGSEntry()` function
  - Auto-creates journal entry:
    - Dr: Cost of Goods Sold
    - Cr: Inventory

#### Testing
- ‚≠ï Test double-entry validation (should reject unbalanced entries)
- ‚≠ï Test GST calculation (intra-state vs inter-state)
- ‚≠ï Test COGS calculation with multiple stock units
- ‚≠ï Test ledger balance calculation

### 7.3 Invoice Management (Week 3)

#### Invoice Creation
- ‚≠ï Create `createInvoiceFromDispatch()` server action
  - Accepts: dispatch_id
  - Creates invoice record
  - Auto-creates journal entries (Customer Dr, Sales Cr, GST Cr)
  - Creates COGS entry
  - Creates inventory movement record
- ‚≠ï Create `createStandaloneInvoice()` server action
  - For manual invoice creation (without dispatch)
  - Links to customer, items, amounts
- ‚≠ï Add GST calculation to invoice
  - Based on customer state vs company state
  - Auto-fills CGST, SGST, or IGST

#### Invoice Editing & Cancellation
- ‚≠ï Create `updateInvoice()` server action
  - Updates invoice details
  - Re-creates journal entries if amounts changed
- ‚≠ï Create `cancelInvoice()` server action
  - Creates reversal journal entry
  - Updates invoice status to 'cancelled'

#### Payment Status Tracking
- ‚≠ï Create `updateInvoicePaymentStatus()` function
  - Checks total payments_received for invoice
  - Updates status: 'unpaid', 'partial', 'paid'

#### Invoice UI
- ‚≠ï Create invoice listing page (`/dashboard/accounting/invoices`)
  - Table with filters (date range, customer, status)
  - Pagination
  - Actions: View, Edit, Cancel
- ‚≠ï Create invoice detail page (`/dashboard/accounting/invoices/[id]`)
  - Full invoice details
  - Linked goods dispatch
  - Payment history
  - Download PDF button
- ‚≠ï Create invoice creation form
  - Option 1: Create from goods dispatch
  - Option 2: Standalone creation
  - GST auto-calculation
  - Preview before save

#### Invoice PDF & E-Invoice
- ‚≠ï Create invoice PDF generator
  - Company letterhead
  - GST-compliant format
  - QR code (if e-invoice enabled)
- ‚≠ï Create E-invoice IRN generation
  - API integration with NIC e-invoice portal
  - Store IRN in invoice record
  - Embed QR code in PDF
- ‚≠ï Add error handling for e-invoice failures

#### Integration with Goods Dispatch
- ‚≠ï Add "Create Invoice" button to goods dispatch detail page
- ‚≠ï Auto-fill invoice from dispatch data
- ‚≠ï Link invoice_id back to goods_dispatches table

#### Testing
- ‚≠ï Test invoice creation from dispatch
- ‚≠ï Test standalone invoice creation
- ‚≠ï Test journal entry auto-creation
- ‚≠ï Test GST calculation (CGST+SGST vs IGST)
- ‚≠ï Test payment status updates
- ‚≠ï Test invoice PDF generation
- ‚≠ï Test e-invoice IRN generation

### 7.4 Payment Management (Week 3)

#### Payment Received
- ‚≠ï Create `recordPaymentReceived()` server action
  - Creates payment_received record
  - Creates journal entry (Bank Dr, Customer Cr)
  - Updates invoice payment status
  - Supports partial payments
- ‚≠ï Add payment allocation to multiple invoices
  - User can split payment across invoices
- ‚≠ï Create payment receipt PDF generator

#### Payment Made
- ‚≠ï Create `recordPaymentMade()` server action
  - Creates payment_made record
  - Creates journal entry (Supplier Dr, Bank Cr)
  - Updates bill payment status
- ‚≠ï Add payment allocation to multiple bills

#### Payment UI
- ‚≠ï Create payments received listing page
  - Filter by customer, date range, payment method
- ‚≠ï Create payment received form
  - Select customer
  - Enter amount, payment method
  - Allocate to invoices
  - Preview journal entry
- ‚≠ï Create payments made listing page
- ‚≠ï Create payment made form
  - Select supplier
  - Allocate to purchase bills

#### Payment Methods
- ‚≠ï Add payment method options
  - Cash, Bank Transfer, UPI, Cheque, Credit Card
- ‚≠ï Add bank account selection (for bank transfers)
- ‚≠ï Add cheque number field (for cheques)

#### Testing
- ‚≠ï Test payment received creation
- ‚≠ï Test payment allocation to multiple invoices
- ‚≠ï Test journal entry auto-creation
- ‚≠ï Test payment status updates on invoices

### 7.5 Purchase Bill Management (Week 4)

#### Purchase Bill Creation
- ‚≠ï Create `createPurchaseBillFromReceipt()` server action
  - Accepts: receipt_id
  - Creates purchase_bill record
  - Auto-creates journal entries (Purchase Dr, GST Dr, Supplier Cr)
  - Links to goods_receipt
- ‚≠ï Create `createStandalonePurchaseBill()` server action

#### Purchase Bill UI
- ‚≠ï Create purchase bills listing page
- ‚≠ï Create purchase bill detail page
- ‚≠ï Create purchase bill form
  - Option 1: From goods receipt
  - Option 2: Standalone
  - GST input credit auto-calculation

#### Integration with Goods Receipt
- ‚≠ï Add "Create Purchase Bill" button to goods receipt detail page
- ‚≠ï Link bill_id back to goods_receipts table

#### Testing
- ‚≠ï Test bill creation from receipt
- ‚≠ï Test journal entry auto-creation
- ‚≠ï Test GST input credit calculation

### 7.6 Expense Tracking (Week 4)

#### Expense Categories
- ‚≠ï Create predefined expense categories
  - Rent, Salary, Transport, Utilities, Marketing, Office Supplies
- ‚≠ï Allow custom categories per company

#### Expense Recording
- ‚≠ï Create `addExpense()` server action
  - Creates expense record
  - Creates journal entry (Expense Dr, Cash/Bank Cr)
  - Auto-posts to P&L

#### Expense UI
- ‚≠ï Create expenses listing page
  - Filter by category, date range, payment method
- ‚≠ï Create expense form
  - Select category
  - Enter amount, description, date
  - Select payment method

#### Testing
- ‚≠ï Test expense creation
- ‚≠ï Test journal entry auto-creation
- ‚≠ï Test expense categorization

### 7.7 Financial Reports (Week 5)

#### Trial Balance
- ‚≠ï Create `generateTrialBalance()` function
  - Groups by ledger_account
  - Calculates Dr total, Cr total
  - Validates Dr = Cr
- ‚≠ï Create Trial Balance report page
  - Date range filter
  - Export to Excel/PDF
  - Drill-down to ledger statement

#### Profit & Loss Statement
- ‚≠ï Create `generateProfitLoss()` function
  - Revenue (Income accounts)
  - - Direct Expenses (Purchases, COGS)
  - = Gross Profit
  - - Indirect Expenses
  - = Net Profit
- ‚≠ï Create P&L report page
  - Period selection
  - Comparative columns (This Year vs Last Year)
  - Export to Excel/PDF

#### Balance Sheet
- ‚≠ï Create `generateBalanceSheet()` function
  - Assets (Current + Fixed)
  - Liabilities (Current + Long-term)
  - Capital + Profit/Loss
  - Validates Assets = Liabilities
- ‚≠ï Create Balance Sheet report page
  - As on date selection
  - Comparative columns

#### Outstanding Reports
- ‚≠ï Create `generateARAgingReport()` function
  - Customer-wise outstanding
  - Aging buckets: 0-30, 31-60, 61-90, 90+
- ‚≠ï Create `generateAPAgingReport()` function
  - Supplier-wise payables
- ‚≠ï Create AR Aging report page
- ‚≠ï Create AP Aging report page

#### Cash Flow Statement
- ‚≠ï Create `generateCashFlowStatement()` function
  - Operating activities
  - Investing activities
  - Financing activities
- ‚≠ï Create Cash Flow report page

#### Ledger Statement
- ‚≠ï Create `generateLedgerStatement()` function
  - All transactions for a ledger
  - Running balance
- ‚≠ï Create Ledger Statement page
  - Select ledger
  - Date range

#### Reports Dashboard
- ‚≠ï Create reports dashboard page
  - Quick links to all reports
  - Summary widgets

#### Export Functionality
- ‚≠ï Add Excel export for all reports
- ‚≠ï Add PDF export for all reports

#### Testing
- ‚≠ï Test Trial Balance accuracy (manual verification)
- ‚≠ï Test P&L accuracy
- ‚≠ï Test Balance Sheet (Assets = Liabilities)
- ‚≠ï Test AR/AP aging calculations
- ‚≠ï Test report exports

### 7.8 GST Compliance (Week 5)

#### GSTR-1 Report
- ‚≠ï Create `generateGSTR1()` function
  - B2B section (invoices with GSTIN)
  - B2C section (state-wise summary for invoices without GSTIN)
  - HSN summary (item-wise with quantities)
- ‚≠ï Create GSTR-1 report page
  - Month selection
  - Export to JSON (GSTN format)
  - Excel summary for review
- ‚≠ï Validate JSON format against GSTN schema

#### GSTR-3B Summary
- ‚≠ï Create `generateGSTR3B()` function
  - Outward supplies (from sales)
  - Input tax credit (from purchases)
  - Net tax payable
- ‚≠ï Create GSTR-3B summary page
  - Month selection
  - Section-wise breakdown

#### E-Invoice Integration
- ‚≠ï Integrate with NIC E-Invoice API
  - Authentication
  - IRN generation
  - QR code generation
- ‚≠ï Add E-Invoice settings page
  - Enable/disable
  - API credentials
- ‚≠ï Auto-generate IRN on invoice creation (if enabled)
- ‚≠ï Handle E-Invoice errors gracefully

#### GST Returns Dashboard
- ‚≠ï Create GST returns dashboard
  - GSTR-1 status (filed/pending)
  - GSTR-3B status
  - Tax liability summary

#### Testing
- ‚≠ï Test GSTR-1 B2B section
- ‚≠ï Test GSTR-1 B2C section
- ‚≠ï Test HSN summary
- ‚≠ï Test GSTR-3B calculations
- ‚≠ï Test E-Invoice IRN generation
- ‚≠ï Validate JSON exports

### 7.9 Tally Integration - Export (Week 6)

#### XML Export Structure
- ‚≠ï Create Tally XML generator
  - Header (company name, period)
  - Body (masters, transactions)
- ‚≠ï Map account_groups to Tally groups
- ‚≠ï Map ledger_accounts to Tally ledgers
- ‚≠ï Map journal_entries to Tally vouchers
  - Invoice ‚Üí Sales Voucher
  - Purchase Bill ‚Üí Purchase Voucher
  - Payment Received ‚Üí Receipt Voucher
  - Payment Made ‚Üí Payment Voucher
  - Expense ‚Üí Journal Voucher

#### Export Functionality
- ‚≠ï Create `exportToTallyXML()` function
  - Date range selection
  - Export type: Masters only, Transactions only, Full
- ‚≠ï Create export preview
  - Shows what will be exported
  - Validation checks
- ‚≠ï Create "Export to Tally" page
  - Date range picker
  - Export type selection
  - Download XML button

#### Validation
- ‚≠ï Validate XML against Tally schema
- ‚≠ï Ensure Trial Balance matches in Tally after import
- ‚≠ï Test with Tally Prime import

#### Testing
- ‚≠ï Export sample data to XML
- ‚≠ï Import XML into Tally Prime
- ‚≠ï Verify Trial Balance matches exactly
- ‚≠ï Test with large datasets (1000+ transactions)

### 7.10 Tally Integration - Import (Week 6)

#### XML Parser
- ‚≠ï Create Tally XML parser
  - Parse company info
  - Parse ledgers
  - Parse vouchers
- ‚≠ï Handle Tally-specific formats

#### Opening Balances Import
- ‚≠ï Create `importOpeningBalances()` function
  - Parse all ledgers with closing balances
  - Create ledger_accounts
  - Create partners (for customers/suppliers)
  - Create opening journal entry
  - Validate Trial Balance

#### Transaction History Import
- ‚≠ï Create `importTransactions()` function
  - Convert Sales Voucher ‚Üí Invoice + journal_entries
  - Convert Purchase Voucher ‚Üí Purchase Bill + journal_entries
  - Convert Receipt ‚Üí Payment Received
  - Convert Payment ‚Üí Payment Made
  - Convert Journal ‚Üí Journal Entry
- ‚≠ï Link imported records to original Tally voucher GUID

#### Import UI
- ‚≠ï Create "Import from Tally" page
  - File upload
  - Import type selection (opening balances / transactions)
  - Period selection
  - Preview before import
- ‚≠ï Show import progress
- ‚≠ï Show import summary (records created, errors)

#### Validation & Error Handling
- ‚≠ï Validate Trial Balance after import
- ‚≠ï Handle duplicate imports gracefully
- ‚≠ï Show import errors clearly

#### Testing
- ‚≠ï Test opening balances import
- ‚≠ï Test transaction history import
- ‚≠ï Verify Trial Balance matches Tally
- ‚≠ï Test with sample Tally company data

### 7.11 Inventory-Accounting Integration (Week 7)

#### Auto-Accounting Triggers
- ‚≠ï Create trigger: goods_dispatch ‚Üí auto-create invoice
  - Optional (user can enable/disable)
  - Auto-fills invoice from dispatch data
- ‚≠ï Create trigger: goods_receipt ‚Üí auto-create purchase bill
  - Auto-fills bill from receipt data
- ‚≠ï Update stock_units table with accounting links
  - Add journal_entry_id column
  - Track which entry created/consumed the stock

#### COGS Auto-Calculation
- ‚≠ï Implement COGS calculation on dispatch
  - Query stock_units.purchase_rate (FIFO order)
  - Create COGS journal entry:
    - Dr: Cost of Goods Sold
    - Cr: Inventory
- ‚≠ï Link COGS entry to dispatch

#### Inventory Valuation Report
- ‚≠ï Create inventory valuation report
  - Stock value from stock_units.purchase_rate
  - Matches Balance Sheet "Inventory" account
- ‚≠ï Add reconciliation check
  - Stock valuation = Inventory ledger balance

#### End-to-End Testing
- ‚≠ï Test complete flow: Receipt ‚Üí Bill ‚Üí Payment
  - Create goods receipt
  - Auto-create purchase bill
  - Record payment
  - Verify journal entries
  - Check Trial Balance
- ‚≠ï Test complete flow: Dispatch ‚Üí Invoice ‚Üí Payment ‚Üí COGS
  - Create goods dispatch
  - Auto-create invoice
  - Calculate COGS
  - Record payment
  - Verify all journal entries
  - Check Trial Balance, P&L, Balance Sheet

### 7.12 UI/UX Development (Week 7)

#### Navigation
- ‚≠ï Add "Accounting" section to dashboard navigation
  - Invoices
  - Payments
  - Expenses
  - Reports
  - Settings

#### Dashboard Widgets
- ‚≠ï Create accounting dashboard widgets
  - Total Sales (current month)
  - Total Purchases (current month)
  - Outstanding Receivables
  - Outstanding Payables
  - Cash & Bank Balance
  - Quick actions (Create Invoice, Record Payment)

#### Settings Page
- ‚≠ï Create accounting settings page
  - Company GSTIN
  - Financial year start date
  - Default GST rate
  - E-Invoice settings
  - Tally sync settings
  - Auto-accounting toggles

#### Help & Tooltips
- ‚≠ï Add tooltips to all accounting fields
- ‚≠ï Add help text for complex concepts
  - What is a journal entry?
  - How does GST calculation work?

#### Mobile Responsiveness
- ‚≠ï Test all accounting pages on mobile
- ‚≠ï Fix layout issues
- ‚≠ï Optimize table displays for mobile

#### Loading States
- ‚≠ï Add loading skeletons to report generation
- ‚≠ï Add progress indicators for import/export

#### Error Boundaries
- ‚≠ï Add error boundaries to accounting module
- ‚≠ï Graceful error handling

### 7.13 Testing & Validation (Week 7)

#### Unit Testing
- ‚≠ï Test double-entry validation function
- ‚≠ï Test GST calculation function
- ‚≠ï Test COGS calculation function
- ‚≠ï Test ledger balance calculation
- ‚≠ï Test journal entry creation

#### Integration Testing
- ‚≠ï Test invoice creation from dispatch
- ‚≠ï Test purchase bill from receipt
- ‚≠ï Test payment allocation
- ‚≠ï Test expense posting
- ‚≠ï Test report generation accuracy

#### End-to-End Testing
- ‚≠ï Complete sales cycle: Dispatch ‚Üí Invoice ‚Üí Payment
- ‚≠ï Complete purchase cycle: Receipt ‚Üí Bill ‚Üí Payment
- ‚≠ï Verify Trial Balance accuracy
- ‚≠ï Verify P&L accuracy
- ‚≠ï Verify Balance Sheet (Assets = Liabilities)

#### GST Testing
- ‚≠ï Test intra-state GST (CGST + SGST)
- ‚≠ï Test inter-state GST (IGST)
- ‚≠ï Test GSTR-1 report accuracy
- ‚≠ï Test GSTR-3B calculations
- ‚≠ï Test E-Invoice IRN generation

#### Tally Integration Testing
- ‚≠ï Export sample data to Tally XML
- ‚≠ï Import into Tally Prime
- ‚≠ï Verify Trial Balance matches exactly
- ‚≠ï Import Tally data (opening balances)
- ‚≠ï Verify Trial Balance after import

#### Performance Testing
- ‚≠ï Test with 1000+ invoices
- ‚≠ï Test with 5000+ journal entries
- ‚≠ï Measure report generation time (target < 2s)
- ‚≠ï Test concurrent transactions

#### Bug Fixes
- ‚≠ï Document all bugs found
- ‚≠ï Prioritize and fix critical bugs
- ‚≠ï Retest after fixes

### 7.14 Documentation & Deployment

#### API Documentation
- ‚≠ï Document all server actions
- ‚≠ï Document database schema
- ‚≠ï Document journal entry structure

#### User Guide
- ‚≠ï Create user guide for accounting module
  - How to create invoices
  - How to record payments
  - How to track expenses
  - How to generate reports
  - How to import from Tally
  - How to export to Tally

#### Video Tutorials (Optional)
- ‚≠ï Create invoice tutorial
- ‚≠ï Create payment recording tutorial
- ‚≠ï Create reports tutorial

#### Code Documentation
- ‚≠ï Add JSDoc comments to accounting functions
- ‚≠ï Document complex logic
- ‚≠ï Update README

#### Database Backup
- ‚≠ï Create full database backup before deployment
- ‚≠ï Test restore procedure

#### Staging Deployment
- ‚≠ï Run migrations in staging
- ‚≠ï Test accounting module in staging
- ‚≠ï Verify no breaking changes to inventory

#### Production Deployment
- ‚≠ï Run migrations in production
- ‚≠ï Deploy code to production
- ‚≠ï Monitor for errors
- ‚≠ï Check performance metrics

#### Post-Deployment Monitoring
- ‚≠ï Monitor error rates
- ‚≠ï Monitor performance (report generation time)
- ‚≠ï Check user feedback
- ‚≠ï Fix any critical issues

#### Rollback Plan
- ‚≠ï Document rollback procedure
- ‚≠ï Test rollback in staging
- ‚≠ï Keep backup for 30 days

---

**Last Updated:** 2025-01-24
**Current Phase:**
- Phase 1 ‚úÖ COMPLETED - Authentication with Google OAuth + Email OTP
- Phase 2-6 ‚è≥ PENDING - Performance, Standardization, UI/UX, Cleanup, Testing
- Phase 7 ‚≠ï READY TO START - Accounting Module Integration

**Current Task:** Accounting module documentation complete. Ready to start Week 1: Database Schema & Migrations.

**Total Phase 7 Tasks:** 141 tasks across 14 categories (7-week implementation)

**Key Dependencies:**
- 7.2 depends on 7.1 (need tables before creating engine)
- 7.3-7.6 depend on 7.2 (need engine before transactions)
- 7.7-7.8 depend on 7.3-7.6 (need data before reports)
- 7.9-7.10 depend on 7.1-7.7 (need complete system for Tally sync)
- 7.11 depends on 7.1-7.10 (integration is final piece)
- 7.12-7.14 are parallel/final tasks
