# Bale Inventory - Development Tasks

## ‚úÖ CHECKPOINT: Upgrade Flow Implementation (Oct 13, 2025)

### What Was Completed
Successfully implemented the upgrade request and approval system that allows demo users to request full platform access without polluting the users table until admin approval.

**Key Achievement**: Maintained design principle that demo users authenticate without creating database records until their upgrade is approved by admin.

### Changes Made
1. **Database Schema**
   - Created `upgrade_requests` table with RLS policies
   - Added policy to allow users to query their own auth_user_id from users table
   - Migration: `create_upgrade_requests_table`
   - Migration: `allow_users_to_query_own_auth_id`

2. **API Routes**
   - Complete rewrite: `app/api/request-invite/route.ts` (uses upgrade_requests table)
   - Complete rewrite: `app/api/admin/approve-upgrade/route.ts` (creates company/user/warehouse)
   - Fixed column name: is_super_admin ‚Üí is_superadmin

3. **Frontend Pages**
   - Fixed: `app/dashboard/request-upgrade/page.tsx` (handles users without DB records)
   - Updated: `app/dashboard/admin/invite-requests/page.tsx` (fetches from upgrade_requests)
   - Updated: `app/dashboard/admin/invite-requests/InviteRequestsClient.tsx` (new interface)
   - Created: `app/(auth)/login/page.tsx` (OTP-based login)

4. **Git Work**
   - Branch: feat/upgrade-flow-with-requests-table
   - Merged to main (no PR)
   - Pushed to remote
   - Comprehensive documentation: `docs/UPGRADE_FLOW_IMPLEMENTATION.md`

### Test Results (Oct 12, 2025) ‚úÖ
- **Approved Request**: Chirag Bolar (productmanagerchiragbolar@gmail.com) for "Chi fabrics"
- **Approved At**: 2025-10-12 17:05:48 UTC
- **Approved By**: bale.inventory@gmail.com (superadmin)
- **Company Created**: Chi fabrics (ID: a86a3118-0a77-4527-bb09-969e849b64e3)
- **User Created**: Chirag Bolar with role=admin, is_demo=false, is_active=true

### Testing Status
- [x] Demo user can authenticate and access dashboard
- [x] Request form loads and accepts submissions
- [x] Requests are saved to upgrade_requests table
- [x] Admin can view pending requests
- [x] Test approval flow end-to-end (completed Oct 12)
- [x] Verify user gets full access after approval (completed Oct 12)

### Outcome
‚úÖ **Upgrade flow fully tested and working** - Demo users can request access, admins can approve, and user records + companies are created successfully on approval.

### Next Steps
1. ‚úÖ ~~Test complete approval flow~~ (Completed Oct 12)
2. Build product/inventory modules to populate warehouse on approval (future)
3. Add email notifications on approval (future enhancement)
4. Consider rejection flow with admin notes (future enhancement)

---

## ‚úÖ CHECKPOINT: Multi-Tenant Architecture Validation (Oct 13, 2025)

### What Was Validated
Successfully validated that the existing database schema is production-ready for multi-tenant SaaS architecture with role-based access control.

**Key Achievement**: Confirmed schema supports tenant isolation, multi-warehouse operations, demo ‚Üí upgrade flow, and QR code generation without needing structural changes.

### Validation Results

1. **Schema Structure Confirmed** ‚úÖ
   ```
   auth.users (Supabase Auth)
       ‚Üì auth_user_id (FK)
   public.users (Application users)
       ‚Üì company_id (FK)
   companies (Tenant root)
       ‚Üì company_id (FK)
   All 25 data tables (Tenant-isolated data)
   ```

2. **Tenant Isolation Verified** ‚úÖ
   - ALL 25 tables have `company_id` for tenant isolation
   - Core tables checked: companies, users, warehouses, products, stock_units, goods_dispatches, goods_receipts, sales_orders, partners, job_works, barcode_batches
   - Warehouse-scoped tables have both `company_id` AND `warehouse_id`
   - QR code generation tables (barcode_batches) are tenant-isolated

3. **Multi-Warehouse Support Confirmed** ‚úÖ
   - Admin users: `warehouse_id = NULL` (access all warehouses)
   - Staff users: `warehouse_id` set (limited to assigned warehouse)
   - All warehouse-level operations properly scoped

4. **Two-Tier Access System** ‚úÖ
   - Demo users: Exist in `auth.users` only, no `public.users` record
   - Full users: Have record in both `auth.users` AND `public.users`
   - `upgrade_requests` table mediates transition from demo ‚Üí full
   - Upgrade approval atomically creates: company ‚Üí user ‚Üí warehouse

### Key Architectural Decisions

1. **No Members Junction Table** ‚úÖ
   - Simple one-user-one-company model sufficient for textile trader use case
   - Direct `company_id` FK in users table
   - Can add members table later if multi-company per user becomes needed

2. **RLS & Auth Hook Implementation Deferred** ‚è∞
   - Build core features FIRST with manual `company_id` filtering
   - Implement RLS policies and Auth Hooks at the END (security hardening phase)
   - Auth Hooks already enabled in project, ready when needed

3. **Validated Table Structure** ‚úÖ
   - users.role: 'admin' | 'staff'
   - users.warehouse_id: NULL for admin, set for staff
   - users.is_demo: boolean (demo vs full user)
   - users.is_superadmin: boolean (platform admin flag)
   - All critical tables have proper tenant isolation

### Research Sources Consulted
- Supabase official documentation (Context7)
- 2025 best practices articles (AntStack, RoughlyWritten)
- Supabase Auth Hooks documentation
- Multi-tenancy patterns and RLS implementation guides
- PRD.md permission matrix validation

### Implementation Priority

**NOW (Phases 5-9): Build Core Features**
- Products Management
- Inventory Management
- Sales Orders
- Partners Management
- Settings & Administration
- Use manual `company_id` filtering in queries
- Apply application-level role checks

**LATER (After Phase 9): Security Hardening**
- Implement RLS policies on all 25 tables
- Configure Auth Hook to inject JWT claims (company_id, role, warehouse_id)
- Add database triggers for automatic tenant_id population
- Create security definer functions for elevated privilege operations
- Test RLS bypass scenarios and edge cases

### Next Steps
1. ‚úÖ ~~Validate existing schema against PRD requirements~~ (Completed Oct 13)
2. ‚úÖ ~~Document architectural decisions~~ (Completed Oct 13)
3. **Begin Phase 5: Products Management** (READY TO START)
4. Continue with Phases 6-9 (core feature development)
5. Security hardening phase after core features complete

---

## ‚ö†Ô∏è Migration Strategy Decision Point (Oct 11, 2025)

### Current Situation
- **Database**: Cloud production (Supabase MCP, not local)
- **Migrations**: 26 files with duplicates and column bloat
- **Status**: MVP stage with 3 test users
- **Issue**: Invites table has 21 columns (should be ~10)

### Best Practices Research (2025)
‚úÖ **Incremental migrations** strongly preferred for production
‚ùå **Big bang refactors** high risk, avoid unless necessary
‚úÖ **Use Supabase branching** for safe testing (beta feature)

### Recommended Approach: Clean Core Now
**Focus**: Companies, Users, Warehouses, Invites (foundation)
**Keep**: Products, Sales, Job Works, Goods Movement (build incrementally)
**Method**: Use Supabase branching to test safely

### Decision Pending
- Option A: Clean core migrations now (2-3 hours, solid foundation)
- Option B: Pure incremental (safer but builds on messy foundation)
- Option C: Wait until later (complexity compounds)

**See `.claude.md`** for detailed context and Supabase branching commands

---

## üéØ Current Sprint: Core Features Implementation

### Phase 1: Foundation & Setup ‚úÖ
- [x] Initialize Next.js 15 with TypeScript, Tailwind CSS, App Router
- [x] Set up folder structure (app routes, components, lib, types)
- [x] Install Supabase dependencies (@supabase/ssr, @supabase/supabase-js)
- [x] Configure Supabase client (browser and server)
- [x] Set up local Supabase with Docker
- [x] Create complete database schema (16 migrations)
- [x] Apply migrations locally
- [x] Initialize Git repository
- [x] Push to GitHub (https://github.com/CHIBOLAR/Bale3)

### Phase 2: Authentication & Security ‚úÖ
- [x] Implement Supabase Auth integration
- [x] Create signup page with company onboarding
- [x] Create login page
- [x] Build auth layout component
- [x] Implement middleware for route protection
- [x] Create Supabase server client with cookie handling
- [x] Test signup flow (creates company + admin user + default warehouse)
- [x] Test login flow with redirect to dashboard
- [x] Integrate Google OAuth (Sign in with Google)
- [x] Create OAuth callback handler
- [x] Implement invite system (platform + staff invites)
- [x] Add invite code validation to signup
- [x] Create invite system database schema
- [x] Add is_super_admin flag to users table
- [x] Create setup guides (Google OAuth + Invite System)
- [x] Configure Google OAuth redirect URIs in production
- [x] Implement email-based invite validation for OAuth users
- [x] Production testing completed (both signup methods verified)

### Phase 2B: Upgrade Request System ‚úÖ (Completed Oct 13, 2025)
- [x] Database changes
  - [x] Create upgrade_requests table with RLS policies
  - [x] Add RLS policy for users to query own auth_user_id
  - [ ] Create shared demo company with warehouse (future)
  - [ ] Populate demo data (products, partners, orders) (future)
- [x] Upgrade request system
  - [x] Create request form page (app/dashboard/request-upgrade/page.tsx)
  - [x] Create API route for submission (app/api/request-invite/route.ts)
  - [x] Save to upgrade_requests table
  - [x] Handle demo users without DB records
  - [x] Success confirmation
- [x] Admin upgrade management
  - [x] List pending upgrade requests (app/dashboard/admin/invite-requests/page.tsx)
  - [x] Approve action with company creation (app/api/admin/approve-upgrade/route.ts)
  - [x] Create company + user record + warehouse on approval
  - [x] Update request status
  - [ ] Reject action with admin notes (future)
- [x] Authentication fixes
  - [x] Created login page (app/(auth)/login/page.tsx)
  - [x] Fixed OTP-based authentication flow
  - [x] Fixed RLS policies for demo users
- [ ] Homepage with magic link (pending)
  - [ ] Create public homepage (app/page.tsx)
  - [ ] Email input + "Try Demo" button
  - [ ] Magic link send via signInWithOtp
  - [ ] Success confirmation UI
  - [ ] Features showcase section
- [ ] Dashboard demo UX (pending)
  - [ ] Add demo banner for demo users
  - [ ] Disable create buttons for demo
  - [ ] "Request Official Access" CTA
- [ ] Email integration (future)
  - [ ] Set up email service (MSG91 configured but domain verification pending)
  - [ ] Send approval notifications
  - [ ] Send rejection notifications
  - [ ] Create email templates
- [x] Testing & QA (completed Oct 12)
  - [x] Test demo user authentication
  - [x] Test upgrade request submission
  - [x] Test admin viewing pending requests
  - [x] Test complete approval flow end-to-end
  - [x] Test user access after upgrade
- [x] Production deployment (completed)
  - [x] Push migrations to production
  - [x] Deploy code changes
  - [x] Merge to main branch

### Phase 3: Dashboard Layout ‚úÖ
- [x] Create dashboard layout with navigation
- [x] Build DashboardNav component
- [x] Implement logout functionality
- [x] Create dashboard home page with stats cards
- [x] Display company and user information
- [x] Add quick action links

### Phase 4: Deployment Preparation ‚úÖ
- [x] Create .env.example file
- [x] Write comprehensive Hostinger deployment guide
- [x] Document production Supabase setup
- [x] Document PM2 process manager configuration
- [x] Push deployment guide to GitHub
- [x] Link local project to production Supabase (project ref: xejyeglxigdeznfitaxc)
- [x] Push all migrations to production database (18 migrations total)
- [x] Configure production environment variables
- [x] Test production authentication with Google OAuth and email/password
- [x] Update context files (claude.md, todo.md, context.md)

---

## üöß Phase 5: Products Management (IN PROGRESS)
- [ ] Create products list page with table
  - [ ] Fetch products from Supabase
  - [ ] Display product details (name, fabric type, color, GSM, price)
  - [ ] Add search/filter functionality
  - [ ] Implement pagination
- [ ] Create product detail/edit page
  - [ ] Display full product information
  - [ ] Edit form with validation
  - [ ] Save changes to database
- [ ] Create new product page
  - [ ] Form with all required fields (fabric type, color, GSM, etc.)
  - [ ] Form validation (Zod schema)
  - [ ] Submit to database
  - [ ] Redirect to products list
- [ ] Image upload functionality (future)
  - [ ] Set up Supabase Storage bucket
  - [ ] Upload component (max 5 images, 2MB each)
  - [ ] Image display and management

---

## üìã Phase 6: Inventory Management (PENDING)
- [ ] Create goods receipt page
  - [ ] Form to record incoming stock
  - [ ] Partner selection (supplier)
  - [ ] Product selection
  - [ ] Quantity and pricing inputs
  - [ ] Automatic stock unit creation
- [ ] Create stock units list page
  - [ ] Display all stock units with status
  - [ ] Warehouse filtering
  - [ ] Status badges (in_stock, reserved, dispatched, sold)
  - [ ] Search by barcode or product
- [ ] Create stock unit detail page
  - [ ] Display unit information
  - [ ] Show history (receipts, dispatches, orders)
  - [ ] Edit unit details (if not dispatched)
- [ ] Goods dispatch functionality
  - [ ] Dispatch form (to partner or warehouse transfer)
  - [ ] Stock unit selection with validation
  - [ ] Update stock status on dispatch

---

## üìã Phase 7: Sales Orders (PENDING)
- [ ] Create sales orders list page
  - [ ] Display orders with status
  - [ ] Filter by status, customer, date
  - [ ] Show fulfillment progress
- [ ] Create new sales order page
  - [ ] Customer selection
  - [ ] Line items with product selection
  - [ ] Quantity and pricing
  - [ ] Order status workflow
- [ ] Sales order detail page
  - [ ] View order details
  - [ ] Track fulfillment by warehouse
  - [ ] Update order status
  - [ ] Link dispatches to order
- [ ] Order approval workflow (if needed)
  - [ ] Pending approval status
  - [ ] Admin approval action

---

## üìã Phase 8: Partners Management (PENDING)
- [ ] Create partners list page
  - [ ] Display all partners with type badges
  - [ ] Filter by type (customer, supplier, vendor, agent)
  - [ ] Search by name or contact
- [ ] Create new partner page
  - [ ] Form with contact details
  - [ ] Partner type selection
  - [ ] Address information
  - [ ] Save to database
- [ ] Partner detail/edit page
  - [ ] View partner information
  - [ ] Edit form
  - [ ] View transaction history (orders, dispatches, receipts)

---

## üìã Phase 9: Settings & Administration (PENDING)
- [ ] Company profile page
  - [ ] Display company information
  - [ ] Edit company details (admin only)
- [ ] Warehouses management (admin only)
  - [ ] List all warehouses
  - [ ] Create new warehouse
  - [ ] Edit warehouse details
  - [ ] Deactivate warehouse (soft delete)
- [ ] Staff management (admin only)
  - [ ] List all staff users
  - [ ] Create new staff user (via invite system)
  - [ ] Assign warehouse to staff
  - [ ] Update user role
  - [ ] Deactivate user
- [ ] Platform invites management (super admin only)
  - [ ] List all platform invites
  - [ ] Create new platform invite
  - [ ] Revoke invite
  - [ ] View invite usage stats
- [ ] Staff invites management (admin)
  - [ ] List staff invites for company
  - [ ] Create staff invite
  - [ ] Resend invite
  - [ ] Revoke invite

---

## üìã Phase 10: Job Works (PENDING)
- [ ] Job works list page
  - [ ] Display all job works with status
  - [ ] Filter by type (dyeing, printing, embroidery)
  - [ ] Show assigned partner
- [ ] Create new job work
  - [ ] Partner selection (vendor)
  - [ ] Job work type and details
  - [ ] Raw material dispatch
  - [ ] Expected completion date
- [ ] Job work detail page
  - [ ] Track progress
  - [ ] Record finished goods receipt
  - [ ] Calculate costs
  - [ ] Complete job work

---

## üìã Phase 11: Barcode System (PENDING)
- [ ] Barcode generation page
  - [ ] Select stock units
  - [ ] Customize barcode fields
  - [ ] Generate QR codes
  - [ ] Export to PDF for printing
- [ ] Barcode scanning functionality
  - [ ] PWA camera integration
  - [ ] Scan barcode to view stock unit
  - [ ] Quick dispatch via barcode scan
  - [ ] Quick search via barcode

---

## üìã Phase 12: Public Sales Catalog (PENDING)
- [ ] Public catalog browsing
  - [ ] Display available products
  - [ ] Filter by fabric type, color, price
  - [ ] Product detail view with images
- [ ] Shopping cart functionality
  - [ ] Add products to cart
  - [ ] Update quantities
  - [ ] Cart summary
- [ ] Checkout and order creation
  - [ ] Customer information form
  - [ ] Review order
  - [ ] Submit order (creates sales order)
- [ ] Catalog configuration (admin)
  - [ ] Enable/disable catalog
  - [ ] Branding settings
  - [ ] Product visibility settings

---

## üìã Phase 13: UI/UX Enhancements (PENDING)
- [ ] Install shadcn/ui components
  - [ ] Button, Input, Select
  - [ ] Table, Dialog, Dropdown
  - [ ] Badge, Card, Tabs
- [ ] Create reusable components
  - [ ] DataTable with sorting/filtering
  - [ ] StatusBadge component
  - [ ] FileUpload component
  - [ ] SearchInput component
- [ ] Form components
  - [ ] ProductForm
  - [ ] PartnerForm
  - [ ] OrderForm
  - [ ] With validation (Zod + React Hook Form)
- [ ] Mobile optimization
  - [ ] Responsive layouts
  - [ ] Touch-friendly buttons
  - [ ] Bottom navigation for mobile
  - [ ] Swipe gestures

---

## üìã Phase 14: PWA & Performance (PENDING)
- [ ] PWA configuration
  - [ ] Create manifest.json
  - [ ] Add service worker
  - [ ] Configure icons
  - [ ] Enable offline mode
- [ ] Performance optimization
  - [ ] Image optimization
  - [ ] Lazy loading
  - [ ] Code splitting
  - [ ] Caching strategies
- [ ] Camera permissions
  - [ ] Request camera access
  - [ ] Test barcode scanning

---

## üìã Phase 15: Testing (PENDING)
- [ ] Unit tests
  - [ ] Utility functions
  - [ ] Form validations
  - [ ] Custom hooks
- [ ] Integration tests
  - [ ] CRUD operations
  - [ ] Authentication flow
  - [ ] Order workflows
- [ ] User acceptance testing
  - [ ] Admin user flows
  - [ ] Staff user flows
  - [ ] Mobile device testing

---

## üìã Phase 16: Production Deployment (PENDING)
- [ ] Create production Supabase project
- [ ] Run migrations on production
- [ ] Configure production environment variables
- [ ] Build production bundle
- [ ] Deploy to Hostinger
- [ ] Configure domain and SSL
- [ ] Set up PM2 for process management
- [ ] Test production deployment
- [ ] Monitor application performance

---

## üêõ Known Issues
- None currently identified

---

## üí° Future Enhancements
- [ ] Rust + Axum backend for improved performance
- [ ] Advanced reporting and analytics
- [ ] Multi-currency support
- [ ] Email notifications
- [ ] SMS integration for order updates
- [ ] Integration with accounting software
- [ ] Mobile app (React Native)
- [ ] Real-time notifications (Supabase Realtime)
- [ ] Export to Excel/CSV
- [ ] Backup and restore functionality

---

## üìù Notes
- Focus on MVP features first (Phases 5-9)
- **Multi-Tenancy Strategy**: Use manual `company_id` filtering in queries for now; RLS policies will be implemented after core features (security hardening phase)
- **Role-Based Permissions**: Apply at application level (admin vs staff, warehouse access) until Auth Hook JWT claims are configured
- Test admin vs staff permissions for each feature
- Keep mobile-first approach in mind
- Document API endpoints as they're created
- Regular Git commits with meaningful messages

### Upgrade Flow Implementation Notes (Oct 12-13, 2025)
- **Design Principle**: Demo users authenticate via Supabase Auth but do NOT get a record in public.users table until admin approves their upgrade request
- **Database Separation**: `upgrade_requests` table stores pending requests separately from `users` table
- **Critical RLS Fix**: Added policy allowing users to query for their own `auth_user_id` even without DB record
- **Approval Creates Everything**: On approval, system creates company ‚Üí user record in single transaction
- **Column Name Issue**: Database uses `is_superadmin` (no underscore between "super" and "admin"), not `is_super_admin`
- **Email Service**: MSG91 configured but requires domain verification for sending emails
- **Testing Complete**: ‚úÖ Full approval flow tested successfully on Oct 12, 2025
  - Approved Chirag Bolar's request for "Chi fabrics" company
  - Company created with ID: a86a3118-0a77-4527-bb09-969e849b64e3
  - User record created with role=admin, is_demo=false, is_active=true
  - Warehouse creation will be added when inventory modules are built
- **Documentation**: Complete technical documentation available in `docs/UPGRADE_FLOW_IMPLEMENTATION.md`
