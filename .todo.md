# Bale - POC Accounting & Inventory App

## Current Status
- ✅ Inventory Module (Goods Receipt, Dispatch, Stock Tracking)
- ⏳ Accounting Module (in progress)

---

## POC Goal
**Working accounting-inventory system for 1 accountant to evaluate in 10 days**

Success Criteria:
- Import opening balances via CSV (100 ledgers in 5 minutes)
- Create 10 invoices from goods dispatch
- Record payments (cash/credit/partial)
- View trial balance + P&L + balance sheet (verify Dr = Cr)

---

## Phase 1: Core Accounting (Days 1-10) ⏳

### Day 1-2: Invoice Finalization + Edit + Credit Notes ✅ COMPLETE
- ✅ Run `npm run build` (passed with 0 errors)
- ✅ Update test data (product prices, company state, partner states)
- ✅ Database verified (14 system ledgers, 5 dispatches ready)
- ✅ Edit invoice page with 24h window check
- ✅ Credit note page with journal entry reversal
- ✅ Credit note journal entries (Dr Sales/GST, Cr Customer)
- ⭕ Test invoice auto-creation from goods dispatch (READY TO TEST)
- ⭕ Verify journal entries in database (Dr = Cr)
- ⭕ Test edit + credit note flow end-to-end

### Day 3-4: Trial Balance CSV Import ⭕
**Files:** `app/dashboard/onboarding/import-trial-balance/page.tsx`, `lib/accounting/trial-balance-csv.ts`, `app/actions/accounting/trial-balance-import.ts`

- ⭕ CSV template (3-row: Entry Type, Headers, Data)
- ⭕ Preview table with error highlighting
- ⭕ Validate Dr = Cr before import
- ⭕ Import creates ledgers + opening journal entry

### Day 5: Invoice List & Detail Pages ✅ COMPLETE
**Files:** `app/dashboard/invoices/page.tsx`, `app/dashboard/invoices/[id]/page.tsx`

- ✅ Invoice list (date, customer, amount, status)
- ✅ Invoice detail with journal entry view (shows Dr/Cr breakdown)
- ✅ View linked goods dispatch
- ✅ Navigation link added to sidebar

### Day 6-7: Payment Recording ✅ COMPLETE
**Files:** `app/dashboard/invoices/[id]/record-payment/page.tsx`, `app/actions/accounting/payments.ts`, `components/accounting/PaymentForm.tsx`

- ✅ Manual entry form (amount, method, reference)
- ✅ Payment methods: Cash, Bank, Cheque, UPI
- ✅ Partial payment support
- ✅ Section 269ST check (block cash >₹2L)
- ✅ Auto journal entry (Dr Cash/Bank, Cr Customer)
- ✅ Balance due calculation and display

### Day 8-10: Basic Reports ⭕
**Files:** `app/dashboard/reports/page.tsx`, `lib/accounting/reports.ts`

- ⭕ Trial Balance (all ledgers, Dr/Cr totals)
- ⭕ Profit & Loss (Revenue - Expenses)
- ⭕ Balance Sheet (Assets = Liabilities + Equity)
- ⭕ Outstanding Receivables (unpaid invoices)

---

## Phase 2: Polish & Scale (Days 11-20) ⭕

### Customer/Product Import ⭕
- ⭕ CSV import for customers
- ⭕ CSV import for products

### GST Compliance ⭕
- ⭕ GSTR-1 report (local calculation, no API)
- ⭕ E-invoice generation (sandbox API)

### Purchase Bills ⭕
- ⭕ Mirror of sales invoices for purchases
- ⭕ Link to goods receipt

---

## Deferred (Post-POC)
- Tally XML import/export
- Multi-currency
- Bank reconciliation
- Advanced permissions
- E-way bill generation
- GSTR-3B

---

## Current Sprint
**Completed:** Day 1-2 (Invoice + Edit + Credit Note) + Day 5 + Day 6-7 ✅
**Status:** All core invoice functionality built, ready for testing
**Next:**
1. Test end-to-end: Create invoice from dispatch → Edit → Create credit note
2. Verify journal entries in database (Dr = Cr for all transactions)
3. Build Day 8-10: Reports (Trial Balance, P&L, Balance Sheet)
4. Build Day 3-4: Trial Balance CSV Import

---

## NEW: TallyPrime Integration Sprint (8 Weeks)

### Overview
**Goal:** Build invoice management + TallyPrime sync to eliminate double-entry for fabric traders
**Strategy:** Generate GST invoices in app → Auto-sync to Tally via HTTP+XML → Tally handles GST compliance
**Users:** Admin, Accountant (new role), Staff (read-only)

### What We're Building
1. **Purchase Orders** - Track supplier orders, link to Goods Receipts
2. **Invoice Management** - Sales/Purchase invoices with GST compliance
3. **Payment Tracking** - Record payments, update invoice balances
4. **TallyPrime Sync** - HTTP+XML integration, queue for Silver edition
5. **Accountant Role** - Company-wide billing access, read-only inventory

---

### Sprint 1-2: Foundation (Weeks 1-2) ⏳

**Database Schema:**
- [ ] Create `purchase_orders` table (order_number, supplier_id, warehouse_id, status, total_amount)
- [ ] Create `purchase_order_items` table (product_id, required_qty, received_qty, unit_rate)
- [ ] Create `sales_invoices` table (invoice_number, customer_id, sales_order_ids[], GST fields, paid_amount, status)
- [ ] Create `sales_invoice_items` table (product_id, quantity, unit_rate, GST breakdown per line)
- [ ] Create `purchase_invoices` table (supplier invoice, purchase_order_ids[], GST fields)
- [ ] Create `purchase_invoice_items` table (similar to sales)
- [ ] Add `accountant` to user_role enum
- [ ] Update RLS policies for new tables (admin/accountant/staff access)

**Backend Logic:**
- [ ] Purchase Order CRUD (admin only)
- [ ] Auto-update PO status based on Goods Receipts
- [ ] Sales Invoice creation from Sales Order (full/partial/consolidated)
- [ ] GST auto-calculation (intra-state: CGST+SGST, inter-state: IGST)
- [ ] Invoice status auto-update based on payments

**UI Pages:**
- [ ] Purchase Orders list & create/edit pages
- [ ] Sales Invoices list & create page
- [ ] Invoice creation wizard (from order/consolidated/standalone)
- [ ] Basic payment recording UI

**Deliverable:** Can create purchase orders and basic invoices

---

### Sprint 3-4: Core Invoice Features (Weeks 3-4) ⏳

**Invoice Workflows:**
- [ ] Partial invoicing (invoice 100m of 150m ordered, track remaining)
- [ ] Consolidated invoice (multiple orders → one invoice for same customer)
- [ ] Standalone invoice (no order, walk-in sales)
- [ ] Invoice edit (draft state only)
- [ ] Invoice cancel/void functionality

**Payment System:**
- [ ] Create `payment_entries` table (payment_number, type, partner_id, amount, mode)
- [ ] Create `payment_allocations` table (split payment across multiple invoices)
- [ ] Payment recording UI (received/paid, allocate to invoices)
- [ ] Auto-update invoice paid_amount and status
- [ ] Payment mode: Cash, Bank Transfer, Cheque, UPI

**GST Invoice PDF:**
- [ ] PDF template with all GST-compliant fields (GSTIN, HSN, tax breakdown)
- [ ] Company logo, authorized signatory
- [ ] Amount in words, bank details
- [ ] Download/Email/WhatsApp options

**Deliverable:** Full invoice workflows with PDF generation

---

### Sprint 5-6: TallyPrime Integration (Weeks 5-6) ⏳

**Database Schema:**
- [ ] Create `tally_settings` table (company-level: tally_url, edition, godown_mapping)
- [ ] Create `tally_sync_queue` table (entity_type, entity_id, status, retry_count, xml_request/response)

**Tally Configuration:**
- [ ] Tally settings UI (connection URL, company name, edition detection)
- [ ] Test connection endpoint (verify Tally reachable)
- [ ] Warehouse → Godown mapping UI
- [ ] Manual sync trigger button

**XML Generation:**
- [ ] Build XML generator service (sales voucher, purchase voucher, payment voucher)
- [ ] Include godown in inventory allocations
- [ ] GST ledger entries (CGST/SGST/IGST)
- [ ] Bill-wise details for payments

**HTTP Sync Service:**
- [ ] HTTP POST to Tally (port 9000)
- [ ] XML response parser (success/error handling)
- [ ] Extract tally_voucher_number from response
- [ ] Error logging and retry logic (max 3 attempts)

**Queue System (Silver Edition):**
- [ ] Background worker (runs every 30s)
- [ ] Process queue sequentially (wait 2s between requests)
- [ ] UI shows queue position and estimated time
- [ ] Retry failed syncs with exponential backoff

**Sync Status Dashboard:**
- [ ] Connection status indicator
- [ ] Pending queue count
- [ ] Recent syncs (last 10, success/failed)
- [ ] Manual retry for failed items
- [ ] View sync logs (XML request/response for debugging)

**Deliverable:** Working Tally sync for all invoice types

---

### Sprint 7-8: Testing & Polish (Weeks 7-8) ⏳

**Multi-Warehouse Testing:**
- [ ] Test sync from 3 warehouses to central Tally
- [ ] Verify godown allocation in Tally
- [ ] Test concurrent sync (Gold edition)
- [ ] Test queue system (Silver edition)

**Error Handling:**
- [ ] Network timeout handling
- [ ] Tally offline/unreachable scenario
- [ ] Invalid ledger name errors
- [ ] GST rate mismatch errors
- [ ] Duplicate voucher prevention

**UI/UX Polish:**
- [ ] Loading states for sync operations
- [ ] Success/error toast notifications
- [ ] Clear error messages for users
- [ ] Sync status indicators on invoice list
- [ ] Accountant dashboard (pending invoices, unpaid amounts)

**Documentation:**
- [ ] Admin guide: Tally setup (enable HTTP server, port forwarding, IP whitelist)
- [ ] Accountant training: Invoice creation, payment recording
- [ ] Developer docs: XML format reference, API endpoints

**Performance:**
- [ ] Invoice creation < 2 seconds
- [ ] Tally sync < 5 seconds (immediate) or < 5 min (queued)
- [ ] PDF generation < 3 seconds
- [ ] Sync success rate > 95%

**Deliverable:** Production-ready accounting module with Tally integration

---

### Database Tables Summary

**New Tables (8):**
1. `purchase_orders` - Supplier order management
2. `purchase_order_items` - Line items for PO
3. `sales_invoices` - Customer invoices with GST
4. `sales_invoice_items` - Line items with per-item GST
5. `purchase_invoices` - Supplier bills
6. `purchase_invoice_items` - Line items for supplier bills
7. `payment_entries` - Payment transactions
8. `payment_allocations` - Split payments across invoices
9. `tally_settings` - Tally connection config per company
10. `tally_sync_queue` - Sync queue for Silver edition

**Modified:**
- `user_profiles` or `users` - Add `accountant` role

---

### API Endpoints to Build

**Purchase Orders:**
- `POST /api/purchase-orders` - Create PO
- `GET /api/purchase-orders` - List POs (filtered by warehouse/company)
- `PUT /api/purchase-orders/:id` - Update PO
- `DELETE /api/purchase-orders/:id` - Delete PO

**Sales Invoices:**
- `POST /api/sales-invoices` - Create invoice
- `GET /api/sales-invoices` - List invoices
- `PUT /api/sales-invoices/:id` - Update draft invoice
- `POST /api/sales-invoices/:id/finalize` - Finalize & send
- `GET /api/sales-invoices/:id/pdf` - Generate PDF
- `POST /api/sales-invoices/:id/cancel` - Cancel invoice

**Purchase Invoices:**
- `POST /api/purchase-invoices` - Record supplier invoice
- `GET /api/purchase-invoices` - List
- `PUT /api/purchase-invoices/:id` - Update

**Payments:**
- `POST /api/payments` - Record payment
- `GET /api/payments` - List payments
- `GET /api/payments/outstanding/:partner_id` - Outstanding invoices

**Tally Integration:**
- `POST /api/tally/settings` - Save Tally config
- `GET /api/tally/settings` - Get config
- `POST /api/tally/test-connection` - Test Tally connection
- `POST /api/tally/sync/:entity_type/:entity_id` - Manual sync trigger
- `GET /api/tally/sync-status` - Queue status
- `POST /api/tally/retry-failed` - Retry failed syncs

---

### RBAC Matrix

**Accountant Role Permissions:**
- ✅ Create/Edit Sales Invoices (draft state)
- ✅ Create/Edit Purchase Invoices
- ✅ Record Payments
- ✅ View all invoices (company-wide)
- ✅ Trigger Tally sync
- ✅ View inventory (read-only)
- ❌ Create/Edit Purchase Orders
- ❌ Manage Goods Dispatch/Receipt
- ❌ Configure Tally settings

**Staff:**
- View invoices for assigned warehouse only (list view)
- No invoice creation/edit/payment access

**Admin:**
- Full access to all features

---

### Business Rules Summary

**Invoice Creation:**
- Invoice number: Auto-generated `SI-{SEQUENCE}` (no gaps)
- Partial invoicing: `invoice_qty <= (order_qty - already_invoiced_qty)`
- GST: Auto-detect intra/inter state, calculate CGST+SGST or IGST
- Status: draft → sent → partially_paid → paid → overdue

**Payments:**
- Can allocate one payment across multiple invoices
- Auto-update invoice status based on paid_amount
- Block cash payments > ₹2 lakh (Section 269ST)

**Tally Sync:**
- Silver edition: Queue system (sequential, 2s delay)
- Gold edition: Immediate parallel sync
- Include warehouse → godown mapping in all vouchers
- Retry failed syncs max 3 times

---

### Success Metrics

**Functional:**
- ✅ Invoice created from order in < 2 minutes
- ✅ GST calculated correctly (tested intra/inter state)
- ✅ PDF has all mandatory GST fields
- ✅ Tally sync success rate > 95%
- ✅ Multi-warehouse works with godowns

**Performance:**
- Invoice creation: < 2s
- Tally sync (immediate): < 5s
- Tally sync (queued): < 5min average
- PDF generation: < 3s

**Quality:**
- Zero invoice number gaps
- No duplicate syncs to Tally
- Proper error messages for users
- Audit trail for all operations

---

### Questions for Clarification

Before sprint start, confirm:
1. Purchase orders: Need approval workflow? (like sales orders)
2. Credit notes: Needed in MVP or Phase 2?
3. Accountant edit finalized invoices: Allowed or blocked?
4. Payment modes: Any additional needed beyond Cash/Bank/UPI/Cheque?
5. Multi-currency: Needed or INR only?
6. Invoice templates: Single default or customization needed?

---

### Dependencies & Tech Notes

**Libraries:**
- XML generation: Built-in XML builder (no external lib needed)
- HTTP client: axios or node fetch
- PDF: pdfmake or similar GST template library
- Background jobs: pg_cron or separate worker service

**Security:**
- Validate Tally URL (prevent SSRF)
- Sanitize XML content (prevent injection)
- Rate limit Tally API calls
- Encrypt Tally connection settings in DB
- Audit log all invoice/payment operations

**Database Triggers:**
- Auto-update invoice status on payment change
- Auto-update PO status on goods receipt
- Sequential number generation (invoice_number, payment_number)

---

**Current Focus:** Planning complete. Ready to start Sprint 1-2 (Foundation) after POC completion.
