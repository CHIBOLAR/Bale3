# Bale Inventory - Fabric Management System

## Project Overview

**Bale Inventory** is a Next.js-based fabric inventory management system targeting Indian textile traders. The application provides multi-tenant inventory tracking, sales order management, job work processing, and barcode-based stock tracking.

## Tech Stack

- **Frontend**: Next.js 15 (App Router) + TypeScript + Tailwind CSS
- **Database**: Supabase (PostgreSQL with Row Level Security)
- **Authentication**: Supabase Auth Magic Links (passwordless) + Google OAuth
- **Storage**: Supabase Storage for images/files
- **Deployment**: Hostinger + Supabase Cloud
- **Access Control**: Two-tier system - Public demo + Invite-only for official accounts
- **Email**: Resend (custom SMTP for magic links)
- **Future Enhancement**: Rust + Axum backend (post-MVP)

## ‚úÖ Multi-Tenant Architecture Validation (Oct 13, 2025)

### Overview
Comprehensive review of multi-tenant architecture completed. Confirmed production-ready database structure with all required tenant isolation mechanisms in place. Architecture supports two-tier access (demo + full), multi-warehouse management, and role-based permissions per PRD requirements.

### Architecture Validation Results

**‚úÖ Schema Structure Confirmed:**
```
auth.users (Supabase Auth)
    ‚Üì auth_user_id (FK)
public.users (Application users)
    ‚Üì company_id (FK)
companies (Tenant root)
    ‚Üì company_id (FK)
warehouses, products, partners, etc. (Tenant data)
```

**‚úÖ Tenant Isolation:**
- ALL 25 tables have `company_id` for tenant isolation
- Warehouse-scoped tables also have `warehouse_id` (stock_units, goods_receipts, goods_dispatches, job_works)
- QR code/barcode tables (`barcode_batches`) have `company_id` - tenant-isolated by design

**‚úÖ Multi-Warehouse Support:**
- **Admin users**: `warehouse_id = NULL` ‚Üí Access ALL company warehouses
- **Staff users**: `warehouse_id` set ‚Üí Limited to ONE assigned warehouse
- Confirmed in PRD permission matrix (admin sees all warehouses, staff sees assigned warehouse only)

**‚úÖ Two-Tier Access System:**
```
Tier 1 (Demo): auth.users ONLY, no public.users record
    ‚Üì User requests upgrade
upgrade_requests table (pending approval)
    ‚Üì Admin approves
Tier 2 (Full): Creates company + public.users record + warehouse
```

### Key Architectural Decisions

**1. No Members Junction Table Needed**
- **Decision**: Keep current `public.users` table with direct `company_id` FK
- **Rationale**: One user = one company model fits textile trader business (not accountants/consultants)
- **Benefit**: Simpler architecture, faster MVP development
- **Future**: Can add members table later if multi-company per user is needed

**2. RLS & Auth Hook Deferred**
- **Decision**: Build features first with client-side filtering, add database-level security later
- **Current**: Manual `company_id` filtering in queries
- **Later** (Phase: Security Hardening):
  - Auth Hook (inject company_id, role, warehouse_id into JWT)
  - Triggers (auto-set company_id on INSERT)
  - RLS Policies (enforce at database level)
  - Performance indexes

**3. Validated Table Structure**
```sql
-- Core Tables
companies (id, name, is_demo, ...)
users (id, auth_user_id, company_id, role, warehouse_id, is_demo, is_superadmin, ...)
warehouses (id, company_id, name, ...)

-- Data Tables (all have company_id)
products, partners, sales_orders, job_works
stock_units, goods_receipts, goods_dispatches
barcode_batches, catalog_configurations, invites, product_variants

-- System Tables (auth-level)
upgrade_requests (no company_id until approval)
```

### Confirmed User Flows

**Demo User Journey:**
1. Sign up via Supabase Auth ‚Üí `auth.users` created
2. NO `public.users` record created (key difference!)
3. User can still authenticate and access read-only dashboard
4. User requests upgrade ‚Üí stored in `upgrade_requests`
5. Admin approves ‚Üí atomically creates:
   - Company record (is_demo: false)
   - User record (auth_user_id linked, company_id set, role: admin)
   - Default warehouse

**Admin User Capabilities:**
- Manage multiple warehouses (warehouse_id = NULL)
- Full CRUD on all company data across all warehouses
- Create/assign staff to specific warehouses
- View all inventory, orders, dispatches across all warehouses

**Staff User Capabilities:**
- Limited to ONE assigned warehouse (warehouse_id set)
- View company products (read-only)
- Manage inventory in assigned warehouse only
- Create goods receipts/dispatches for assigned warehouse
- Cannot access other warehouses or manage settings

### Research & Validation Sources

**Validated Against:**
- ‚úÖ Supabase official docs (2025 best practices)
- ‚úÖ Context7 Supabase documentation
- ‚úÖ Community best practices (AntStack, RoughlyWritten articles)
- ‚úÖ PRD permission matrix requirements
- ‚úÖ Existing production database schema

**Key Patterns Confirmed:**
1. Single Supabase project for all tenants (cost-effective, recommended)
2. `tenant_id` (company_id) on ALL data tables (strict isolation)
3. Auth Hooks for JWT claims injection (2025 approach)
4. Triggers for auto-populating tenant_id
5. Shared dimension tables for common lookups (optional)

### Implementation Priority

**NOW - Build Features (Phases 5-9):**
- Products Management
- Inventory/Goods Receipts
- Sales Orders
- Partners Management
- Job Works
- Manual `company_id` filtering in queries is sufficient for MVP

**LATER - Security Hardening:**
- Auth Hook implementation
- Trigger functions
- RLS policies
- Performance indexes

### Files to Reference
- **PRD**: `PRD.md` (complete permission matrix, user flows)
- **Upgrade Flow**: `docs/UPGRADE_FLOW_IMPLEMENTATION.md`
- **Current Sprint**: `.todo.md` (Phase 5-9 breakdown)

---

## ‚úÖ Upgrade Flow Implementation Completed (Oct 12, 2025)

### Overview
Implemented a complete upgrade request system where demo users can request full platform access without creating database records until admin approval. This maintains the design principle of "no user record until approval" while providing a clean request management system.

### What Was Done
- ‚úÖ **Created `upgrade_requests` table**: Separate table for storing upgrade requests (not in users table)
- ‚úÖ **Updated request-invite API**: Stores requests in new table, no user record created until approval
- ‚úÖ **Updated approve-upgrade API**: Creates company + user record + warehouse on approval
- ‚úÖ **Fixed RLS policies**: Added policy to allow users to query their own auth_user_id without DB record
- ‚úÖ **Created login page**: OTP-based login page that was previously deleted
- ‚úÖ **Fixed admin panel**: Updated to fetch from upgrade_requests table, fixed column name issues
- ‚úÖ **Fixed superadmin access**: Updated bale.inventory@gmail.com permissions
- ‚úÖ **Comprehensive documentation**: Created `docs/UPGRADE_FLOW_IMPLEMENTATION.md`
- ‚úÖ **Git management**: Merged to main branch with proper commit messages

### Database Changes

**New Table: `upgrade_requests`**
```sql
- id, auth_user_id, email, name, phone, company, message
- status (pending/approved/rejected)
- created_at, updated_at, approved_at, approved_by
- rejected_at, rejected_by, rejection_reason
```

**New Migration: `allow_users_to_query_own_auth_id`**
- RLS policy allowing authenticated users to query for their own auth_user_id
- Enables demo users without DB records to check if they exist

### User Flow

**Demo User Journey:**
1. User authenticates (exists in auth.users only, no public.users record)
2. User browses dashboard in demo mode
3. User clicks "Request Upgrade" ‚Üí fills form (name, phone, company, message)
4. Request stored in `upgrade_requests` table (status: pending)
5. User continues using demo while waiting

**Admin Approval Journey:**
1. Admin logs into admin panel at `/dashboard/admin/invite-requests`
2. Admin sees pending requests with user details
3. Admin clicks "Approve & Upgrade Instantly"
4. System creates: new company ‚Üí user record ‚Üí default warehouse
5. Request marked as approved
6. User can now log in with full access

### Files Changed
- `app/api/request-invite/route.ts` - Rewritten to use upgrade_requests table
- `app/api/admin/approve-upgrade/route.ts` - Rewritten to create user on approval
- `app/dashboard/request-upgrade/page.tsx` - Fixed to handle users without DB records
- `app/dashboard/admin/invite-requests/page.tsx` - Updated to fetch from upgrade_requests
- `app/dashboard/admin/invite-requests/InviteRequestsClient.tsx` - Updated interface
- `app/(auth)/login/page.tsx` - Created (was previously deleted)
- Database migrations applied to production

### Git Status
- **Branch**: `feat/upgrade-flow-with-requests-table` (merged to main)
- **Commit**: 32f95a9 - "feat: Implement upgrade flow with dedicated requests table"
- **Merge Commit**: 5f8776e - "Merge feat/upgrade-flow-with-requests-table"
- **Status**: ‚úÖ Pushed to main and deployed

### Testing Checklist
- ‚úÖ Demo user can authenticate without user record
- ‚úÖ Demo user can access dashboard
- ‚úÖ Demo user can view request-upgrade page
- ‚úÖ Demo user can submit upgrade request
- ‚úÖ Admin can access admin panel with correct permissions
- ‚úÖ Admin can see pending requests
- ‚úÖ Admin approval creates company + user record (tested Oct 12, 2025)
- ‚úÖ Approved user has full admin access (tested Oct 12, 2025)

### Test Results (Oct 12, 2025)
- **Approved Request**: Chirag Bolar (productmanagerchiragbolar@gmail.com) for "Chi fabrics"
- **Approved At**: 2025-10-12 17:05:48 UTC
- **Approved By**: bale.inventory@gmail.com (superadmin)
- **Company Created**: Chi fabrics (ID: a86a3118-0a77-4527-bb09-969e849b64e3)
- **User Created**: Chirag Bolar with role=admin, is_demo=false, is_active=true
- **Status**: ‚úÖ Complete upgrade flow tested successfully

### Next Steps
1. ‚úÖ ~~Test the complete approval flow~~ (Completed Oct 12, 2025)
2. Build product/inventory modules to populate warehouse on approval (future)
3. Add email notifications on approval (future enhancement)
4. Consider rejection flow with admin notes (future enhancement)

### Documentation
See `docs/UPGRADE_FLOW_IMPLEMENTATION.md` for complete technical documentation including:
- Problem solved and solution architecture
- Detailed database changes and RLS policies
- API endpoint specifications
- Frontend component changes
- Security considerations
- Future improvements

---

## Migration Cleanup Completed (Jan 12, 2025) ‚úÖ

### What Was Done
- ‚úÖ **Removed duplicate migration**: `20251010104313_add_invite_system.sql`
- ‚úÖ **Created clean migration**: `20250112_clean_invites_table.sql`
- ‚úÖ **Reduced invites table**: 19 columns ‚Üí 13 columns (31% reduction)
- ‚úÖ **Preserved all data**: Moved bloat columns to `metadata` JSONB
- ‚úÖ **Updated code**: All references now use metadata instead of removed columns
- ‚úÖ **Documented**: Created `MIGRATION_CLEANUP_ANALYSIS.md` and `TESTING_GUIDE_MIGRATION_CLEANUP.md`

### Columns Removed from Invites Table (6)
1. `accepted_at` - Not used in OTP flow
2. `used_by_email` - Duplicate of email
3. `used_by_user_id` - Moved to metadata.used_by
4. `used_at` - Moved to metadata.used_at
5. `created_by` - Usually same as invited_by
6. `generation_method` - Moved to metadata.generation_method

### Current Clean Schema
**Invites Table (13 columns):**
- Core: `id`, `invite_type`, `code`, `email`, `status`
- References: `company_id`, `warehouse_id`, `role`, `invited_by`
- Timestamps: `created_at`, `updated_at`, `expires_at`
- Flexible: `metadata` (JSONB for request_type, used_at, used_by, etc.)

### Testing Status
‚ö†Ô∏è **Pending**: Migration needs testing before production deployment

**Test Options:**
1. **Option A (Recommended)**: Test on Supabase preview branch
2. **Option B (Riskier)**: Direct production push with backup

See `TESTING_GUIDE_MIGRATION_CLEANUP.md` for complete testing instructions.

### Files Modified
- `supabase/migrations/20250112_clean_invites_table.sql` (new)
- `supabase/migrations/20251010104313_add_invite_system.sql` (deleted)
- `app/api/request-invite/route.ts` (generation_method ‚Üí metadata)
- `app/auth/callback/route.ts` (removed accepted_at)
- `app/api/upgrade-account/route.ts` (removed accepted_at)

### Git Branch
- **Branch**: `feat/clean-core-migrations`
- **Commit**: 1195853 - "feat: Clean up invites table and remove duplicate migration"

### Supabase Branching (Testing Strategy)
**What it is**: Git-like branches for your entire database
- Each branch = separate Supabase instance (DB, Auth, Storage, API)
- Test migrations safely before production
- Auto-merge workflow

**Commands**:
```bash
# Create preview branch
npx supabase branches create clean-invites-test

# Test on branch
npx supabase db push

# Merge to production
npx supabase branches merge clean-invites-test
```

**Note**: Beta feature, requires opt-in, charged separately

### Next Steps
1. Test migration on Supabase preview branch (see TESTING_GUIDE)
2. If tests pass, merge to production
3. Merge `feat/clean-core-migrations` to `main`
4. Continue with Phase 5: Products Management

## Commands

### ‚ö†Ô∏è Important Development Note
**Schema Queries**: Do not query for schema using Supabase MCP tools - it consumes excessive tokens. Instead, ask the user to provide the schema file from migrations or refer to the migration files in `supabase/migrations/`.

### Development
```bash
# Install dependencies
npm install

# Run development server (starts on http://localhost:3000)
npm run dev

# Build for production
npm run build

# Start production server
npm start

# Run linting
npm run lint

# Type checking
npx tsc --noEmit
```

### Supabase Local
```bash
# Start local Supabase (Docker required)
npx supabase start

# Stop local Supabase
npx supabase stop

# Reset database with migrations
npx supabase db reset

# Generate TypeScript types from database
npx supabase gen types typescript --local > types/database.ts

# Access Supabase Studio UI
# http://localhost:54323
```

### Supabase Production
```bash
# Login to Supabase
npx supabase login

# Link to production project
npx supabase link --project-ref YOUR_PROJECT_REF

# Push migrations to production
npx supabase db push

# Pull production schema
npx supabase db pull

# Create preview branch for testing
npx supabase branches create feature-name

# Test migrations on branch
npx supabase db push --branch feature-name

# Merge branch to production
npx supabase branches merge feature-name
```

### Git
```bash
# Check status
git status

# Commit changes
git add .
git commit -m "message"

# Push to GitHub
git push origin main
```

## Architecture

### Multi-Tenant Design
The system uses **company-based multi-tenancy** with Row Level Security:
- **Tenant = Company**: Complete data isolation between companies
- **Role-Based Access**: Admin (full access) vs Staff (warehouse-scoped)
- **Warehouse Scoping**: Staff can only access their assigned warehouse

### Entity Hierarchy
```
Company (Tenant)
‚îú‚îÄ‚îÄ Users (Admin/Staff with warehouse assignment)
‚îú‚îÄ‚îÄ Warehouses (multiple per company)
‚îú‚îÄ‚îÄ Products (company-wide fabric specifications)
‚îú‚îÄ‚îÄ Stock Units (physical fabric rolls in warehouses)
‚îú‚îÄ‚îÄ Partners (Customers, Vendors, Suppliers, Agents)
‚îú‚îÄ‚îÄ Sales Orders (customer orders with fulfillment tracking)
‚îú‚îÄ‚îÄ Job Works (outsourced work: dyeing, printing, embroidery)
‚îú‚îÄ‚îÄ Goods Dispatches (outward stock movement)
‚îî‚îÄ‚îÄ Goods Receipts (inward stock movement)
```

### Access Control Matrix

| Feature | Admin | Staff |
|---------|-------|-------|
| Company Profile | Full CRUD | Read only |
| Warehouses | Full CRUD | No access |
| Users/Staff | Full CRUD | No access |
| Products | Full CRUD | Read only |
| Partners | Full CRUD | Read only |
| Stock Units | All warehouses | Assigned warehouse only |
| Goods Receipts | All warehouses | Assigned warehouse only |
| Goods Dispatches | All warehouses | Assigned warehouse only |
| Sales Orders | Full access | Assigned warehouse only |
| Job Works | All warehouses | Assigned warehouse only |
| Barcode Generation | All warehouses | Assigned warehouse only |
| Public Catalog Config | Full CRUD | No access |

### Database Security
All tables have **Row Level Security (RLS)** policies:
- **Company Isolation**: Users can only see data from their company
- **Warehouse Scoping**: Staff users can only access data from their assigned warehouse
- **Role Checks**: Admin role bypasses warehouse restrictions

### Key Business Logic

**Inventory Flow**:
- Stock can only be **added** via Goods Receipt
- Stock can only be **removed** via Goods Dispatch
- Stock status: `in_stock`, `reserved`, `dispatched`, `sold`

**Fabric-Specific Features**:
- Color management (name + hex code)
- GSM (fabric weight) tracking
- Material types (cotton, polyester, silk, blend, etc.)
- Quality grades (A, B, C, D)
- Measuring units (meters, yards, pieces, kg)

**Audit Trail**:
- All entities have: `created_at`, `updated_at`, `created_by`, `modified_by`, `deleted_at`
- Soft deletes for historical tracking

## Project Structure

```
/app
  /(auth)              # Authentication routes
    /login             # Login page
    /signup            # Company signup page
  /dashboard           # Protected dashboard
    /products          # Product management
    /inventory         # Goods receipts & stock units
    /sales             # Sales orders
    /partners          # Partner management
    /job-works         # Job work tracking
    /barcode           # Barcode generation
    /settings          # Company/warehouse/staff settings
  /catalog             # Public sales catalog
  /api                 # API routes
/components
  /layouts             # Layout components (DashboardNav, etc.)
  /ui                  # Reusable UI components
  /forms               # Form components
/lib
  /supabase
    /client.ts         # Browser Supabase client
    /server.ts         # Server Supabase client (with cookies)
  /utils               # Utility functions
  /validations         # Form validation schemas
/types                 # TypeScript type definitions
/supabase
  /migrations          # Database migration files (16 total)
/public                # Static assets
```

## Current Implementation Status

### ‚úÖ Completed
- [x] Next.js 15 project setup with TypeScript and Tailwind CSS
- [x] Supabase local setup with Docker
- [x] Supabase production setup and migration (18 migrations total)
- [x] Complete database schema including invite system
- [x] Row Level Security policies
- [x] Authentication flow (signup/login with email/password)
- [x] Google OAuth integration (Sign in/up with Google)
- [x] Invite system with email-based validation
  - [x] Platform invites for new companies
  - [x] Staff invites schema (UI pending)
  - [x] Invite validation in OAuth callback
- [x] Company onboarding (creates company + admin user + default warehouse)
- [x] Dashboard layout with navigation
- [x] Dashboard stats (products, stock, orders, partners count)
- [x] Middleware for route protection
- [x] Git repository initialized and pushed to GitHub
- [x] Production testing completed (both signup methods verified)
- [x] Hostinger deployment guide created
- [x] Google OAuth setup guide created
- [x] Invite system setup guide created
- [x] Magic link implementation plan created

### üöß In Progress
- [ ] **Magic Link Two-Tier System** (Phase 2B - See MAGIC_LINK_IMPLEMENTATION_PLAN.md)
  - [ ] Database changes (demo flags, demo company, demo data, RLS)
  - [ ] Auth hook modification (allow signups without invite)
  - [ ] Callback handler (demo vs official company assignment)
  - [ ] Homepage with magic link demo access
  - [ ] Invite request form and API
  - [ ] Admin invite management panel
  - [ ] Dashboard demo user experience
  - [ ] Resend email integration
- [ ] Products management page (CRUD operations)
- [ ] Inventory page (goods receipts)
- [ ] Sales orders page
- [ ] Partners management page

### üìã Pending
- [ ] Warehouses management (admin only)
- [ ] Staff management (admin only)
- [ ] Job works tracking
- [ ] Goods dispatch functionality
- [ ] Barcode generation and scanning
- [ ] Public sales catalog
- [ ] Settings pages
- [ ] Image upload functionality
- [ ] PDF generation for barcodes
- [ ] PWA configuration
- [ ] Mobile optimization

## Environment Variables

### Local Development (.env.local)
```env
NEXT_PUBLIC_SUPABASE_URL=http://127.0.0.1:54321
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_local_anon_key
SUPABASE_SERVICE_ROLE_KEY=your_local_service_role_key
GOOGLE_CLIENT_ID=your_google_client_id
GOOGLE_CLIENT_SECRET=your_google_client_secret
```

### Production (.env.production)
```env
NEXT_PUBLIC_SUPABASE_URL=https://your_project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_production_anon_key
SUPABASE_SERVICE_ROLE_KEY=your_production_service_role_key
GOOGLE_CLIENT_ID=your_google_client_id
GOOGLE_CLIENT_SECRET=your_google_client_secret
```

## Development Workflow

1. **Start Supabase**: `npx supabase start` (Docker must be running)
2. **Run Next.js**: `npm run dev`
3. **Access Application**: http://localhost:3000
4. **Access Supabase Studio**: http://localhost:54323
5. **Make Changes**: Edit code, database auto-reloads
6. **Commit Changes**: `git add . && git commit -m "message" && git push`

## Authentication System - Two-Tier Access

### Overview

Bale Inventory uses a **two-tier authentication system** with Supabase Magic Links:

**Tier 1: Public Demo Access (Frictionless Trial)**
- Anyone can get instant demo access via magic link
- Users are assigned to a shared demo company
- Read-only access to pre-loaded sample data
- No credit card or password required

**Tier 2: Official Company Account (Invite-Only)**
- Requires approved invitation from admin
- Creates dedicated company with full access
- Includes onboarding call and setup assistance
- Complete CRUD operations for all features

### Magic Link Flow

#### Demo Signup (No Invite)
1. User visits homepage ‚Üí Enters email
2. Receives magic link email (Supabase Auth OTP)
3. Clicks link ‚Üí Auth callback checks for invite
4. No invite found ‚Üí Assigned to demo company
5. User record created with `is_demo: true`, `role: customer`
6. Redirected to dashboard with demo data
7. See banner: "You're viewing demo account" + "Request Official Access"

#### Official Signup (With Invite)
1. User explores demo ‚Üí Clicks "Request Official Access"
2. Fills form (name, email, phone, company)
3. Request saved to `invite_requests` table with status `pending`
4. Admin reviews request in admin panel
5. Admin approves ‚Üí System generates invite code
6. User receives email with invite code
7. User clicks invite link ‚Üí Receives magic link
8. Clicks magic link ‚Üí Auth callback finds valid invite
9. New company + warehouse created
10. User record created with `is_demo: false`, `role: admin`
11. Invite marked as `accepted`
12. Redirected to dashboard with own company

### Authentication Methods

**Magic Link (Primary - Recommended)**
- Passwordless authentication
- User enters email ‚Üí Receives link
- Click link to sign in
- Uses Supabase `signInWithOtp({ email })`
- PKCE flow (same device/browser required)

**Google OAuth (Alternative)**
- Social login with Google account
- Auto-validates invite by email
- No password needed
- Works for both demo and official signup

**Email/Password (Legacy)**
- Traditional signup with password
- Requires invite code entry
- Still supported but not primary flow

### Demo Account Features

**What Demo Users Can Do:**
- ‚úÖ View all products (50+ samples)
- ‚úÖ View sales orders (5+ samples)
- ‚úÖ View partners (10+ samples)
- ‚úÖ View stock units
- ‚úÖ Explore dashboard statistics
- ‚úÖ Navigate all pages

**What Demo Users Cannot Do:**
- ‚ùå Create new products
- ‚ùå Create sales orders
- ‚ùå Modify existing data
- ‚ùå Delete records
- ‚ùå Access settings/admin panels
- ‚ùå Generate real barcodes

**Security:**
- Enforced via RLS policies at database level
- Demo users filtered by `is_demo = true`
- Can only SELECT from demo company data
- INSERT/UPDATE/DELETE blocked

### Testing the Application

#### Test Demo Access
1. Go to homepage: http://localhost:3000
2. Enter email address
3. Click "Try Demo"
4. Check email inbox
5. Click magic link
6. Should redirect to dashboard
7. Verify demo banner appears
8. Verify cannot create products (button disabled)

#### Test Official Signup
1. From demo dashboard, click "Request Official Access"
2. Fill out form with details
3. Submit request
4. Admin reviews in `/dashboard/admin/invite-requests`
5. Admin clicks "Approve"
6. Check email for invite code
7. Click invite link or enter code
8. Receive magic link
9. Click magic link
10. Verify new company created
11. Verify full access (can create products)

#### Test Edge Cases
- Click magic link twice (should show error)
- Magic link expired (1 hour timeout)
- Invalid invite code
- Expired invite code (48 hours)
- Demo user requesting invite (should allow)
- Official user trying to access demo (should show own data)

### Verify Database
1. Open Supabase Studio: http://localhost:54323
2. Navigate to Table Editor
3. **Check demo setup:**
   - companies table ‚Üí Find `is_demo = true`
   - users table ‚Üí Check demo users with `is_demo = true`
   - products table ‚Üí Verify 50+ demo products
4. **Check official signup:**
   - companies table ‚Üí New company with `is_demo = false`
   - users table ‚Üí New user with `is_demo = false`, `role = admin`
   - warehouses table ‚Üí New "Main Warehouse" for company
5. **Check invite system:**
   - invite_requests table ‚Üí Pending/approved/rejected requests
   - invites table ‚Üí Generated invite codes with status

## Deployment

Refer to `DEPLOYMENT_GUIDE.md` for complete Hostinger deployment instructions.

### Quick Deployment Steps
1. Create production Supabase project
2. Run migrations: `npx supabase db push`
3. Update `.env.production` with production credentials
4. Build: `npm run build`
5. Upload to Hostinger via SSH or File Manager
6. Run with PM2: `pm2 start npm --name "bale-inventory" -- start`

## Troubleshooting

### Supabase Not Starting
```bash
# Check Docker status
docker ps

# Restart Docker and retry
npx supabase stop
npx supabase start
```

### Migration Errors
```bash
# Reset database completely
npx supabase db reset

# If circular dependency errors, check migration order
# Stock units migration should have nullable created_from_receipt_id
```

### Build Errors
```bash
# Clean and rebuild
rm -rf .next node_modules
npm install
npm run build
```

### Authentication Issues
- Check environment variables are set correctly
- Verify Supabase project is running
- Check browser console for errors
- Verify middleware.ts is configured correctly

## Resources

- **GitHub Repository**: https://github.com/CHIBOLAR/Bale3
- **Supabase Docs**: https://supabase.com/docs
- **Next.js Docs**: https://nextjs.org/docs
- **Deployment Guide**: See DEPLOYMENT_GUIDE.md
- **Project Plan**: See PROJECT_EXECUTION_PLAN.md
- **Google OAuth Setup**: See GOOGLE_OAUTH_SETUP.md
- **Invite System Setup**: See INVITE_SYSTEM_SETUP.md

## Support

For issues or questions:
1. Check existing documentation files
2. Review Supabase logs: `npx supabase status`
3. Check Next.js build errors: `npm run build`
4. Review application logs in browser console
