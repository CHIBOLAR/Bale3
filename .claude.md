# Bale Inventory - Fabric Management System

## Project Overview

**Bale Inventory** is a Next.js-based fabric inventory management system targeting Indian textile traders. The application provides multi-tenant inventory tracking, sales order management, job work processing, and barcode-based stock tracking.

## Tech Stack

- **Frontend**: Next.js 15 (App Router) + TypeScript + Tailwind CSS
- **Database**: Supabase (PostgreSQL with Row Level Security)
- **Authentication**: Supabase Auth Magic Links (passwordless) + Google OAuth
- **Storage**: Supabase Storage for images/files
- **Deployment**: Hostinger + Supabase Cloud
- **Access Control**: Two-tier system - Public demo + Invite-only for official accounts
- **Email**: Resend (custom SMTP for magic links)
- **Future Enhancement**: Rust + Axum backend (post-MVP)

## Migration Cleanup Completed (Jan 12, 2025) ✅

### What Was Done
- ✅ **Removed duplicate migration**: `20251010104313_add_invite_system.sql`
- ✅ **Created clean migration**: `20250112_clean_invites_table.sql`
- ✅ **Reduced invites table**: 19 columns → 13 columns (31% reduction)
- ✅ **Preserved all data**: Moved bloat columns to `metadata` JSONB
- ✅ **Updated code**: All references now use metadata instead of removed columns
- ✅ **Documented**: Created `MIGRATION_CLEANUP_ANALYSIS.md` and `TESTING_GUIDE_MIGRATION_CLEANUP.md`

### Columns Removed from Invites Table (6)
1. `accepted_at` - Not used in OTP flow
2. `used_by_email` - Duplicate of email
3. `used_by_user_id` - Moved to metadata.used_by
4. `used_at` - Moved to metadata.used_at
5. `created_by` - Usually same as invited_by
6. `generation_method` - Moved to metadata.generation_method

### Current Clean Schema
**Invites Table (13 columns):**
- Core: `id`, `invite_type`, `code`, `email`, `status`
- References: `company_id`, `warehouse_id`, `role`, `invited_by`
- Timestamps: `created_at`, `updated_at`, `expires_at`
- Flexible: `metadata` (JSONB for request_type, used_at, used_by, etc.)

### Testing Status
⚠️ **Pending**: Migration needs testing before production deployment

**Test Options:**
1. **Option A (Recommended)**: Test on Supabase preview branch
2. **Option B (Riskier)**: Direct production push with backup

See `TESTING_GUIDE_MIGRATION_CLEANUP.md` for complete testing instructions.

### Files Modified
- `supabase/migrations/20250112_clean_invites_table.sql` (new)
- `supabase/migrations/20251010104313_add_invite_system.sql` (deleted)
- `app/api/request-invite/route.ts` (generation_method → metadata)
- `app/auth/callback/route.ts` (removed accepted_at)
- `app/api/upgrade-account/route.ts` (removed accepted_at)

### Git Branch
- **Branch**: `feat/clean-core-migrations`
- **Commit**: 1195853 - "feat: Clean up invites table and remove duplicate migration"

### Supabase Branching (Testing Strategy)
**What it is**: Git-like branches for your entire database
- Each branch = separate Supabase instance (DB, Auth, Storage, API)
- Test migrations safely before production
- Auto-merge workflow

**Commands**:
```bash
# Create preview branch
npx supabase branches create clean-invites-test

# Test on branch
npx supabase db push

# Merge to production
npx supabase branches merge clean-invites-test
```

**Note**: Beta feature, requires opt-in, charged separately

### Next Steps
1. Test migration on Supabase preview branch (see TESTING_GUIDE)
2. If tests pass, merge to production
3. Merge `feat/clean-core-migrations` to `main`
4. Continue with Phase 5: Products Management

## Commands

### Development
```bash
# Install dependencies
npm install

# Run development server (starts on http://localhost:3000)
npm run dev

# Build for production
npm run build

# Start production server
npm start

# Run linting
npm run lint

# Type checking
npx tsc --noEmit
```

### Supabase Local
```bash
# Start local Supabase (Docker required)
npx supabase start

# Stop local Supabase
npx supabase stop

# Reset database with migrations
npx supabase db reset

# Generate TypeScript types from database
npx supabase gen types typescript --local > types/database.ts

# Access Supabase Studio UI
# http://localhost:54323
```

### Supabase Production
```bash
# Login to Supabase
npx supabase login

# Link to production project
npx supabase link --project-ref YOUR_PROJECT_REF

# Push migrations to production
npx supabase db push

# Pull production schema
npx supabase db pull

# Create preview branch for testing
npx supabase branches create feature-name

# Test migrations on branch
npx supabase db push --branch feature-name

# Merge branch to production
npx supabase branches merge feature-name
```

### Git
```bash
# Check status
git status

# Commit changes
git add .
git commit -m "message"

# Push to GitHub
git push origin main
```

## Architecture

### Multi-Tenant Design
The system uses **company-based multi-tenancy** with Row Level Security:
- **Tenant = Company**: Complete data isolation between companies
- **Role-Based Access**: Admin (full access) vs Staff (warehouse-scoped)
- **Warehouse Scoping**: Staff can only access their assigned warehouse

### Entity Hierarchy
```
Company (Tenant)
├── Users (Admin/Staff with warehouse assignment)
├── Warehouses (multiple per company)
├── Products (company-wide fabric specifications)
├── Stock Units (physical fabric rolls in warehouses)
├── Partners (Customers, Vendors, Suppliers, Agents)
├── Sales Orders (customer orders with fulfillment tracking)
├── Job Works (outsourced work: dyeing, printing, embroidery)
├── Goods Dispatches (outward stock movement)
└── Goods Receipts (inward stock movement)
```

### Access Control Matrix

| Feature | Admin | Staff |
|---------|-------|-------|
| Company Profile | Full CRUD | Read only |
| Warehouses | Full CRUD | No access |
| Users/Staff | Full CRUD | No access |
| Products | Full CRUD | Read only |
| Partners | Full CRUD | Read only |
| Stock Units | All warehouses | Assigned warehouse only |
| Goods Receipts | All warehouses | Assigned warehouse only |
| Goods Dispatches | All warehouses | Assigned warehouse only |
| Sales Orders | Full access | Assigned warehouse only |
| Job Works | All warehouses | Assigned warehouse only |
| Barcode Generation | All warehouses | Assigned warehouse only |
| Public Catalog Config | Full CRUD | No access |

### Database Security
All tables have **Row Level Security (RLS)** policies:
- **Company Isolation**: Users can only see data from their company
- **Warehouse Scoping**: Staff users can only access data from their assigned warehouse
- **Role Checks**: Admin role bypasses warehouse restrictions

### Key Business Logic

**Inventory Flow**:
- Stock can only be **added** via Goods Receipt
- Stock can only be **removed** via Goods Dispatch
- Stock status: `in_stock`, `reserved`, `dispatched`, `sold`

**Fabric-Specific Features**:
- Color management (name + hex code)
- GSM (fabric weight) tracking
- Material types (cotton, polyester, silk, blend, etc.)
- Quality grades (A, B, C, D)
- Measuring units (meters, yards, pieces, kg)

**Audit Trail**:
- All entities have: `created_at`, `updated_at`, `created_by`, `modified_by`, `deleted_at`
- Soft deletes for historical tracking

## Project Structure

```
/app
  /(auth)              # Authentication routes
    /login             # Login page
    /signup            # Company signup page
  /dashboard           # Protected dashboard
    /products          # Product management
    /inventory         # Goods receipts & stock units
    /sales             # Sales orders
    /partners          # Partner management
    /job-works         # Job work tracking
    /barcode           # Barcode generation
    /settings          # Company/warehouse/staff settings
  /catalog             # Public sales catalog
  /api                 # API routes
/components
  /layouts             # Layout components (DashboardNav, etc.)
  /ui                  # Reusable UI components
  /forms               # Form components
/lib
  /supabase
    /client.ts         # Browser Supabase client
    /server.ts         # Server Supabase client (with cookies)
  /utils               # Utility functions
  /validations         # Form validation schemas
/types                 # TypeScript type definitions
/supabase
  /migrations          # Database migration files (16 total)
/public                # Static assets
```

## Current Implementation Status

### ✅ Completed
- [x] Next.js 15 project setup with TypeScript and Tailwind CSS
- [x] Supabase local setup with Docker
- [x] Supabase production setup and migration (18 migrations total)
- [x] Complete database schema including invite system
- [x] Row Level Security policies
- [x] Authentication flow (signup/login with email/password)
- [x] Google OAuth integration (Sign in/up with Google)
- [x] Invite system with email-based validation
  - [x] Platform invites for new companies
  - [x] Staff invites schema (UI pending)
  - [x] Invite validation in OAuth callback
- [x] Company onboarding (creates company + admin user + default warehouse)
- [x] Dashboard layout with navigation
- [x] Dashboard stats (products, stock, orders, partners count)
- [x] Middleware for route protection
- [x] Git repository initialized and pushed to GitHub
- [x] Production testing completed (both signup methods verified)
- [x] Hostinger deployment guide created
- [x] Google OAuth setup guide created
- [x] Invite system setup guide created
- [x] Magic link implementation plan created

### 🚧 In Progress
- [ ] **Magic Link Two-Tier System** (Phase 2B - See MAGIC_LINK_IMPLEMENTATION_PLAN.md)
  - [ ] Database changes (demo flags, demo company, demo data, RLS)
  - [ ] Auth hook modification (allow signups without invite)
  - [ ] Callback handler (demo vs official company assignment)
  - [ ] Homepage with magic link demo access
  - [ ] Invite request form and API
  - [ ] Admin invite management panel
  - [ ] Dashboard demo user experience
  - [ ] Resend email integration
- [ ] Products management page (CRUD operations)
- [ ] Inventory page (goods receipts)
- [ ] Sales orders page
- [ ] Partners management page

### 📋 Pending
- [ ] Warehouses management (admin only)
- [ ] Staff management (admin only)
- [ ] Job works tracking
- [ ] Goods dispatch functionality
- [ ] Barcode generation and scanning
- [ ] Public sales catalog
- [ ] Settings pages
- [ ] Image upload functionality
- [ ] PDF generation for barcodes
- [ ] PWA configuration
- [ ] Mobile optimization

## Environment Variables

### Local Development (.env.local)
```env
NEXT_PUBLIC_SUPABASE_URL=http://127.0.0.1:54321
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_local_anon_key
SUPABASE_SERVICE_ROLE_KEY=your_local_service_role_key
GOOGLE_CLIENT_ID=your_google_client_id
GOOGLE_CLIENT_SECRET=your_google_client_secret
```

### Production (.env.production)
```env
NEXT_PUBLIC_SUPABASE_URL=https://your_project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_production_anon_key
SUPABASE_SERVICE_ROLE_KEY=your_production_service_role_key
GOOGLE_CLIENT_ID=your_google_client_id
GOOGLE_CLIENT_SECRET=your_google_client_secret
```

## Development Workflow

1. **Start Supabase**: `npx supabase start` (Docker must be running)
2. **Run Next.js**: `npm run dev`
3. **Access Application**: http://localhost:3000
4. **Access Supabase Studio**: http://localhost:54323
5. **Make Changes**: Edit code, database auto-reloads
6. **Commit Changes**: `git add . && git commit -m "message" && git push`

## Authentication System - Two-Tier Access

### Overview

Bale Inventory uses a **two-tier authentication system** with Supabase Magic Links:

**Tier 1: Public Demo Access (Frictionless Trial)**
- Anyone can get instant demo access via magic link
- Users are assigned to a shared demo company
- Read-only access to pre-loaded sample data
- No credit card or password required

**Tier 2: Official Company Account (Invite-Only)**
- Requires approved invitation from admin
- Creates dedicated company with full access
- Includes onboarding call and setup assistance
- Complete CRUD operations for all features

### Magic Link Flow

#### Demo Signup (No Invite)
1. User visits homepage → Enters email
2. Receives magic link email (Supabase Auth OTP)
3. Clicks link → Auth callback checks for invite
4. No invite found → Assigned to demo company
5. User record created with `is_demo: true`, `role: customer`
6. Redirected to dashboard with demo data
7. See banner: "You're viewing demo account" + "Request Official Access"

#### Official Signup (With Invite)
1. User explores demo → Clicks "Request Official Access"
2. Fills form (name, email, phone, company)
3. Request saved to `invite_requests` table with status `pending`
4. Admin reviews request in admin panel
5. Admin approves → System generates invite code
6. User receives email with invite code
7. User clicks invite link → Receives magic link
8. Clicks magic link → Auth callback finds valid invite
9. New company + warehouse created
10. User record created with `is_demo: false`, `role: admin`
11. Invite marked as `accepted`
12. Redirected to dashboard with own company

### Authentication Methods

**Magic Link (Primary - Recommended)**
- Passwordless authentication
- User enters email → Receives link
- Click link to sign in
- Uses Supabase `signInWithOtp({ email })`
- PKCE flow (same device/browser required)

**Google OAuth (Alternative)**
- Social login with Google account
- Auto-validates invite by email
- No password needed
- Works for both demo and official signup

**Email/Password (Legacy)**
- Traditional signup with password
- Requires invite code entry
- Still supported but not primary flow

### Demo Account Features

**What Demo Users Can Do:**
- ✅ View all products (50+ samples)
- ✅ View sales orders (5+ samples)
- ✅ View partners (10+ samples)
- ✅ View stock units
- ✅ Explore dashboard statistics
- ✅ Navigate all pages

**What Demo Users Cannot Do:**
- ❌ Create new products
- ❌ Create sales orders
- ❌ Modify existing data
- ❌ Delete records
- ❌ Access settings/admin panels
- ❌ Generate real barcodes

**Security:**
- Enforced via RLS policies at database level
- Demo users filtered by `is_demo = true`
- Can only SELECT from demo company data
- INSERT/UPDATE/DELETE blocked

### Testing the Application

#### Test Demo Access
1. Go to homepage: http://localhost:3000
2. Enter email address
3. Click "Try Demo"
4. Check email inbox
5. Click magic link
6. Should redirect to dashboard
7. Verify demo banner appears
8. Verify cannot create products (button disabled)

#### Test Official Signup
1. From demo dashboard, click "Request Official Access"
2. Fill out form with details
3. Submit request
4. Admin reviews in `/dashboard/admin/invite-requests`
5. Admin clicks "Approve"
6. Check email for invite code
7. Click invite link or enter code
8. Receive magic link
9. Click magic link
10. Verify new company created
11. Verify full access (can create products)

#### Test Edge Cases
- Click magic link twice (should show error)
- Magic link expired (1 hour timeout)
- Invalid invite code
- Expired invite code (48 hours)
- Demo user requesting invite (should allow)
- Official user trying to access demo (should show own data)

### Verify Database
1. Open Supabase Studio: http://localhost:54323
2. Navigate to Table Editor
3. **Check demo setup:**
   - companies table → Find `is_demo = true`
   - users table → Check demo users with `is_demo = true`
   - products table → Verify 50+ demo products
4. **Check official signup:**
   - companies table → New company with `is_demo = false`
   - users table → New user with `is_demo = false`, `role = admin`
   - warehouses table → New "Main Warehouse" for company
5. **Check invite system:**
   - invite_requests table → Pending/approved/rejected requests
   - invites table → Generated invite codes with status

## Deployment

Refer to `DEPLOYMENT_GUIDE.md` for complete Hostinger deployment instructions.

### Quick Deployment Steps
1. Create production Supabase project
2. Run migrations: `npx supabase db push`
3. Update `.env.production` with production credentials
4. Build: `npm run build`
5. Upload to Hostinger via SSH or File Manager
6. Run with PM2: `pm2 start npm --name "bale-inventory" -- start`

## Troubleshooting

### Supabase Not Starting
```bash
# Check Docker status
docker ps

# Restart Docker and retry
npx supabase stop
npx supabase start
```

### Migration Errors
```bash
# Reset database completely
npx supabase db reset

# If circular dependency errors, check migration order
# Stock units migration should have nullable created_from_receipt_id
```

### Build Errors
```bash
# Clean and rebuild
rm -rf .next node_modules
npm install
npm run build
```

### Authentication Issues
- Check environment variables are set correctly
- Verify Supabase project is running
- Check browser console for errors
- Verify middleware.ts is configured correctly

## Resources

- **GitHub Repository**: https://github.com/CHIBOLAR/Bale3
- **Supabase Docs**: https://supabase.com/docs
- **Next.js Docs**: https://nextjs.org/docs
- **Deployment Guide**: See DEPLOYMENT_GUIDE.md
- **Project Plan**: See PROJECT_EXECUTION_PLAN.md
- **Google OAuth Setup**: See GOOGLE_OAUTH_SETUP.md
- **Invite System Setup**: See INVITE_SYSTEM_SETUP.md

## Support

For issues or questions:
1. Check existing documentation files
2. Review Supabase logs: `npx supabase status`
3. Check Next.js build errors: `npm run build`
4. Review application logs in browser console
