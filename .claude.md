

### Complete Database Schema - 32 Tables

#### Core Accounting (8 tables)
1. **`ledger_accounts`** - Chart of accounts (Cash, Bank, Customers, Suppliers, Sales, etc.)
2. **`journal_entries`** - Transaction headers with batch tracking
3. **`journal_entry_lines`** - Dr/Cr lines (enforces Dr = Cr), multi-currency support
4. **`account_groups`** - 28 standard Tally groups (Assets, Liabilities, Income, Expense)
5. **`gst_settings`** - Company GSTIN, state, tax rates, Sandbox credentials
6. **`batches`** - Maker/checker workflow for data entry
7. **`asset_types`** - Multi-currency support (INR, USD, EUR, GBP)
8. **`accounting_periods`** - Period management and year-end close

#### Multi-Currency & Exchange (2 tables)
9. **`exchange_rates`** - Currency conversion rates (auto or manual)
10. **`opening_stock`** - Opening balances for Tally import

#### Inventory-Tally Integration (4 tables)
11. **`stock_groups`** - Hierarchical stock classification (Tally compatible)
12. **`stock_categories`** - Stock categorization (Primary, Sub-assembly, Final)
13. **`units_of_measure`** - Standard units (m, kg, pcs, etc.)
14. **`unit_conversions`** - Unit conversion rates (1m = 1.09361 yards)

#### User-Facing Transactions (5 tables)
15. **`invoices`** - Sales invoices (linked to goods_dispatches) + multi-currency
16. **`payments_received`** - Customer payments + multi-currency
17. **`purchase_bills`** - Purchase bills (linked to goods_receipts) + multi-currency
18. **`payments_made`** - Supplier payments + multi-currency
19. **`expenses`** - Operating expenses with categories

#### Cash Management (6 tables)
20. **`cash_bank_accounts`** - Multiple cash/bank accounts with multi-currency
21. **`cash_denominations`** - Daily physical cash counting
22. **`petty_cash_floats`** - Petty cash float management
23. **`petty_cash_expenses`** - Petty cash expense tracking
24. **`petty_cash_replenishments`** - Float replenishment records
25. **`contra_entries`** - Cash ↔ Bank transfers

#### Supporting & Compliance (3 tables)
26. **`compliance_limits`** - Section 269ST & 40A(3) rules
27. **`bank_statements`** - Bank reconciliation
28. **`tally_import_logs`** - Tally import/export tracking
29. **`e_invoice_logs`** - Sandbox API call tracking

#### User Permissions & RBAC (3 tables)
30. **`roles`** - 5 predefined system roles (Owner, Finance Manager, Accountant, Warehouse Manager, Warehouse Staff)
31. **`permissions`** - 24 granular permissions (inventory.*, accounting.*, reports.*, settings.*)
32. **`role_permissions`** - Mapping table (which role has which permissions)

**Total: 32 Tables** (29 accounting + 3 RBAC)

---

### Auto-Integration Strategy

**80% Auto-Created, 20% Manual**

#### Goods Dispatch → Invoice (Auto)
```
User Action:
  1. Scan QR codes
  2. Select customer
  3. Create Goods Dispatch → Click "Complete"

System Auto-Creates:
  ✅ Invoice record
  ✅ Journal Entry:
      Dr: Customer (₹11,800)
      Cr: Sales (₹10,000)
      Cr: CGST Output (₹900)
      Cr: SGST Output (₹900)
  ✅ COGS Entry:
      Dr: Cost of Goods Sold (₹7,000)
      Cr: Inventory (₹7,000)
  ✅ E-Invoice IRN (if amount > ₹5L and customer has GSTIN)
  ✅ Invoice PDF with QR code

User Sees (on Dispatch detail page):
  📄 Invoice Section (collapsible)
    - Invoice No: INV-2025-0001
    - Amount: ₹11,800
    - Payment Status: Unpaid
    - E-Invoice: ✓ Generated (IRN: ABC123...)
    - [Download PDF] [Record Payment]
```

#### Goods Receipt → Purchase Bill (Auto)
```
User Action:
  1. Receive goods
  2. Select supplier
  3. Generate QR codes
  4. Create Goods Receipt → Click "Complete"

System Auto-Creates:
  ✅ Purchase Bill record
  ✅ Journal Entry:
      Dr: Purchases (₹10,000)
      Dr: CGST Input (₹900)
      Dr: SGST Input (₹900)
      Cr: Supplier (₹11,800)

User Sees (on Receipt detail page):
  📄 Purchase Bill Section
    - Bill No: BILL-2025-0001
    - Amount: ₹11,800
    - Payment Status: Unpaid
    - [Record Payment]
```

#### Payment Recording (Manual Entry - Tally Model)
**Important:** No payment gateway integration. Staff manually records payments received via bank statements/SMS alerts.

```
Real-World Flow:
  1. Customer pays via their bank (NEFT/RTGS/UPI from their account)
  2. You receive bank SMS: "A/c credited ₹5,00,000"
  3. Staff opens app → Accounts → Payments In
  4. Fills form:
     - Customer: ABC Textiles
     - Amount: ₹5,00,000
     - Method: Bank Transfer (or Cash/Cheque/UPI)
     - Reference: NEFT123456789 (from SMS)
     - Bank Account: HDFC Current
     - Allocate to Invoice(s): INV-2025-0001 (₹3L), INV-2025-0005 (₹2L)
  5. Click "Record Payment"

System Auto-Creates:
  ✅ Payment record in payments_received table
  ✅ Journal Entry:
      Dr: HDFC Current A/c (₹5,00,000)
      Cr: ABC Textiles (₹5,00,000)
  ✅ Updates invoice payment status:
      INV-2025-0001: total_paid=₹3L, balance_due=₹0, status='paid'
      INV-2025-0005: total_paid=₹2L, balance_due=₹3L, status='partial'

Compliance Checks (Auto):
  ⚠️ If Cash payment > ₹2,00,000 from same customer in same day
     → BLOCK + Show Section 269ST warning (criminal offense)
  ⚠️ If Cash payment > ₹10,000
     → Warning: Section 40A(3) - expense disallowance for income tax
  ✅ All checks logged for CA audit

Payment Methods Supported:
  • Cash - Physical cash received and deposited
  • Bank Transfer - NEFT/RTGS/IMPS (enter bank reference)
  • Cheque - Enter cheque number, clears after 3 days
  • UPI - Enter UPI transaction ID (from PhonePe/GPay)

Note: UPI/Bank references are manually typed by staff (no API integration)
```

---

### Implementation Timeline - 8 Weeks

#### Week 1: Database Foundation
**Tasks:**
- Create all 32 tables with proper indexes (29 accounting + 3 RBAC)
- Seed 28 standard account groups
- Seed system ledgers (Cash, Bank, Sales, Purchases, GST)
- Seed 5 system roles (Owner, Finance Manager, Accountant, Warehouse Manager, Warehouse Staff)
- Seed 24 permissions (inventory.*, accounting.*, reports.*, settings.*)
- Seed role_permissions mappings
- Create double-entry validation triggers
- Create auto-ledger creation triggers
- Seed standard units of measure
- Seed compliance limits

**Deliverables:**
- All migrations ready
- Database fully seeded with RBAC system
- Trial balance = 0 by default

#### Week 2: Core Accounting Engine
**Tasks:**
- Double-entry validation logic
- Auto-journal entry creation
- GST calculation (CGST+SGST vs IGST based on state)
- COGS calculation (FIFO method)
- Ledger balance calculations
- Multi-currency exchange logic

**Deliverables:**
- `lib/accounting/` module with all core functions
- Test suite for double-entry validation
- GST calculator tested

#### Week 3: Auto-Integration (Inventory → Accounting)
**Tasks:**
- Enhance Goods Dispatch to auto-create invoice
- Enhance Goods Receipt to auto-create purchase bill
- Add Invoice/Bill sections to detail pages
- Implement "Record Payment" buttons
- Link invoices to customer ledgers
- Link bills to supplier ledgers

**Deliverables:**
- `/dashboard/inventory/goods-dispatch/[id]` with invoice section
- `/dashboard/inventory/goods-receipts/[id]` with bill section
- Working auto-accounting

#### Week 4: Accounts Section (Cash & Payments)
**Tasks:**
- Create `/dashboard/accounts` structure
- Cash & Bank accounts management
- Payment In/Out forms with compliance checks
- Daily cash denomination counting
- Contra entries (Cash ↔ Bank)
- Petty cash management
- Move Sales Orders to Accounts

**Deliverables:**
- Full Accounts section working
- Section 269ST/40A(3) compliance checks
- Daily cash count UI

#### Week 5: Reports Section
**Tasks:**
- Financial reports (Trial Balance, P&L, Balance Sheet, Cash Flow)
- GST reports (GSTR-1, GSTR-3B) with JSON export
- Outstanding reports (AR/AP Aging)
- Ledger statement viewer
- Report filters and date ranges
- Excel/PDF export

**Deliverables:**
- `/dashboard/reports` with all reports
- GSTR-1 JSON export (GSTN portal format)
- Drill-down from reports to transactions

#### Week 6: Tally Integration & E-Invoice
**Tasks:**
- Tally XML export generator
- Tally XML import parser
- Opening balances import workflow
- Transaction import with validation
- Sandbox API integration (E-Invoice)
- E-Invoice PDF with QR code
- E-Invoice logs and retry mechanism

**Deliverables:**
- Full Tally import/export working
- E-Invoice generating for eligible invoices
- Sandbox API cost tracking

#### Week 7: Permission System (RBAC)
**Tasks:**
- Create roles, permissions, role_permissions tables
- Create permission infrastructure (`lib/permissions/`)
  - types.ts, definitions.ts, checker.ts, middleware.ts
- Protect all server actions with permission checks
- Update DashboardNav to filter by permissions
- Create permission guard components
- Update Settings > Users page (role assignment UI)
- Hide financial amounts for users without `accounting.view_amounts`
- Test all 5 roles (Owner, Finance Manager, Accountant, Warehouse Manager, Warehouse Staff)
- Test permission boundary violations

**Deliverables:**
- Full RBAC system operational
- All server actions protected
- Navigation filtered by permissions
- Role assignment working in Settings

#### Week 8: Navigation Compaction & Testing
**Tasks:**
- Restructure routes (Sales Orders, Job Works, Staff, Warehouses)
- Update DashboardNav to 6 items
- Add breadcrumbs component
- Settings tabs (Company, Users, Staff, Warehouses, Accounting, GST)
- End-to-end testing with RBAC
- Trial Balance validation
- Tally XML compatibility testing
- Performance testing
- Mobile responsiveness

**Deliverables:**
- Clean 6-item navigation
- All features accessible
- Production-ready accounting module with RBAC
- Documentation complete

---

### Key Design Decisions

✅ **Robert Chanphakeo's Double-Entry Model** - Validated against industry standard
- POSTING table = our `journal_entry_lines`
- JOURNAL table = our `journal_entries`
- ACCOUNT table = our `ledger_accounts`
- BATCH table = our `batches` (maker/checker workflow)

✅ **Tally Compatibility** - 100% XML import/export
- All 28 standard groups
- Stock groups and categories
- Units of measure with conversions
- Opening balances and transactions
- Trial balance validation

✅ **Instant Finalization** - No Approval Workflow
- Invoice created in finalized status immediately when dispatch completes
- Partial invoicing (50 out of 100 units) selected during creation
- Discounts, adjustments applied before creation
- Journal entries created instantly (Dr Customer, Cr Sales, Cr GST)
- Can edit within 24 hours with audit trail
- After 24h, must create credit note to reverse
- Partial payment support with balance tracking

✅ **Clean Navigation** - 6 items only
- Integrated contextually
- Features appear where they're needed
- Progressive disclosure

✅ **CSV Import Strategy** - Dual Import Approach (Frappe Books Inspired)
- **CSV Import Wizard** (Week 1-2) - For onboarding and POC
  - Trial Balance Import (CRITICAL) - Saves 2 hours of manual entry
  - 3-row template system (Entry Type, Field Label, Field Key)
  - Preview with error highlighting (red borders)
  - Partial import support (fix failed, keep successful)
  - Works with Tally CSV exports, Excel, Google Sheets
  - Customers/Products import (optional for POC, can be manual)
- **Tally XML Import** (Week 6) - For complete migration
  - Full masters + historical transactions
  - Power users migrating from Tally
  - Complete data preservation
  - Preview + dry-run mode
  - Partial import with error recovery

**Import Priority for POC:**
1. ✅ Trial Balance CSV (100 ledgers) - CRITICAL - Saves 2 hours
2. ⭕ Customers CSV (10-20 customers) - OPTIONAL - 10 mins manual acceptable
3. ⭕ Products CSV (20-30 products) - OPTIONAL - 15 mins manual acceptable
4. ❌ Historical invoices/payments - NOT NEEDED for POC

✅ **Payment Flexibility** - Cash, Credit, and Partial Payments (Industry Standard)
- **Cash vs Credit**: All invoices default to 'unpaid' (credit), payments recorded separately via `payments_received` table
- **Partial Payments**: Fully supported with `total_paid`, `balance_due`, `payment_status` tracking
- **Payment Methods**: Cash, Bank Transfer, Cheque, UPI (India-specific advantage)
- **Multi-Currency**: Exchange rate tracking on both invoices and payments
- **Payment Allocation**: One invoice can have multiple payments (installments)

**Example Workflow:**
- Invoice: ₹10,000 created (status='unpaid', balance_due=₹10,000)
- Payment 1: ₹3,000 cash → status='partial', balance_due=₹7,000
- Payment 2: ₹7,000 UPI → status='paid', balance_due=₹0

**Validated Against:**
- ✅ Tally - Matches partial payment tracking
- ✅ Zoho Books - Matches payment allocation model
- ✅ QuickBooks - Matches outstanding tracking
- ✅ Frappe Books - Matches multi-payment support

✅ **Payment Gateway Decision** - Manual Recording (No Gateway Integration)
**Decision:** Follow Tally's manual recording model, NOT payment gateway integration (Razorpay/PhonePe)

**Why No Payment Gateway:**
- **Business Model Mismatch**: B2B invoices use 30-90 day credit terms, not instant checkout
- **Transaction Size**: Large amounts (₹50K-₹10L) unsuitable for UPI/gateway limits
- **Customer Control**: Customers pay from their bank portals (NEFT/RTGS), not your app
- **Transaction Costs**: 2% fees = ₹1L/year wasted on ₹50L turnover
- **Corporate Reality**: Business customers don't have UPI, use bank transfers only
- **Partial Payments**: Customers pay in installments via multiple bank transactions
- **POC Speed**: Manual recording takes 2 days to build vs 2 weeks for gateway integration

**What We Build Instead:**
- Manual payment entry form (staff records payment after receiving bank SMS)
- Payment method dropdown: Cash, Bank Transfer, Cheque, UPI (reference manually typed)
- Invoice allocation (₹5L payment split across 3 invoices)
- Section 269ST compliance checks (block cash >₹2L)
- Bank reconciliation via CSV import (Week 6+)

**Payment Gateway Later (Optional - Week 8+):**
- Only for deposit/advance payments (₹5K-₹50K)
- Not for main B2B invoices
- Customer-requested feature only

---

**Last Updated:** 2025-01-30 (Payment gateway decision + payment tracking scope clarified)
**Current Phase:** Phase 7 - Accounting Module Integration ⏳ IN PROGRESS

**Revised Implementation Strategy (CSV-First Approach):**

**Phase 1: POC Essentials (Days 1-10) - Hybrid Approach** ⏳ IN PROGRESS
- Day 1-2: Invoice Finalization + Edit + Credit Notes ✅ COMPLETED (2025-01-30)
- Day 3-4: Trial Balance CSV Import ⭕ NOT STARTED
- Day 5: Invoice List & Detail Pages ✅ COMPLETED (2025-01-29)
- Day 6-7: Payment Recording - Manual Entry ✅ COMPLETED (2025-01-29)
- Day 8-10: Basic Reports (Trial Balance, P&L, GSTR-1) ⭕ NOT STARTED
**POC Ready: Day 10** ✅ Demo to accountant possible (NO payment gateway needed)

**Phase 2: Polish & Completion (Days 11-20)**
- Day 11-12: Customer/Product CSV Import ⭕ NOT STARTED
- Day 13-15: E-Invoice (Part 4) ⭕ NOT STARTED
- Day 16-18: GSTR-1 Filing (Part 5) ⭕ NOT STARTED
- Day 19-20: Purchase Bills (Part 6) ⭕ NOT STARTED

**Phase 3: Full Migration Tools (Week 6)**
- Tally XML Import (complete historical data) ⭕ NOT STARTED
- Preview + dry-run mode
- Partial import with error recovery

**Status:**
- Phase 1-3 ✅ COMPLETED
- Phase 7 - Week 0: Planning & Validation ✅ COMPLETED
- Phase 7 - Week 1: Database Foundation ✅ COMPLETED (32 tables including RBAC)
- Phase 7 - Week 2: Core Accounting Engine ✅ COMPLETED (2025-10-26) - Lean MVP (6 functions)
- Phase 7 - CSV Import Strategy: ✅ PLANNED (2025-01-30) - Frappe Books inspired approach
- Phase 7 - Part 1.5: Refactor to Instant Finalization ✅ COMPLETED (2025-01-29)
- Phase 7 - Day 1-2: Invoice Edit + Credit Notes ✅ COMPLETED (2025-01-30)
- Phase 7 - Day 5: Invoice List & Detail Pages ✅ COMPLETED (2025-01-29)
- Phase 7 - Day 6-7: Payment Recording ✅ COMPLETED (2025-01-29)

**Next Steps (Priority Order):**
1. Test end-to-end invoice flow (create → edit → credit note)
2. Build Day 8-10: Basic Reports (Trial Balance, P&L, Balance Sheet)
3. Build Day 3-4: Trial Balance CSV Import (CRITICAL for POC)
4. Build Day 11-12: Customer/Product CSV Import

**Key Changes (2025-01-30):**
- 🆕 STRATEGIC SHIFT: CSV Import First (not Tally XML)
- 🆕 POC ready in 10 days instead of 20 days
- 🆕 Trial Balance CSV import is the key differentiator
- 🆕 Customers/Products can be manual for POC (25 mins total)
- ✅ Part 1.5 Refactoring COMPLETED: Removed draft/finalize workflow
- ✅ Instant finalization implemented with 24-hour edit window
- ✅ Credit note functionality added
- ✅ Audit logging implemented for all invoice operations
- ✅ Payment flexibility VALIDATED: Cash/Credit/Partial payments match industry standards (Tally, Zoho, QuickBooks, Frappe)
- ✅ Payment Gateway Decision FINALIZED: Manual recording (Tally model), NO payment gateway for POC
- ✅ Payment Tracking Scope CLARIFIED: Staff manual entry from bank SMS/statements (UPI refs typed manually)

**Day 1-2 Completion (2025-01-30 Session):**
- ✅ **Edit Invoice Page** (`app/dashboard/invoices/[id]/edit/page.tsx`)
  - 24-hour edit window with countdown display
  - Blocks edit after 24h or if payments exist
  - Redirects to credit note creation
  - Full EditInvoiceForm component with item editing
- ✅ **Credit Note Page** (`app/dashboard/invoices/[id]/credit-note/page.tsx`)
  - Separate document linked to original invoice
  - Reason field (required for audit trail)
  - Warning about permanent action
  - Prevents duplicate credit notes
- ✅ **CRITICAL BUG FIX: Credit Note Journal Entries**
  - Created `createCreditNoteJournalEntry()` in `lib/accounting/invoice.ts`
  - Properly reverses invoice entries (Dr Sales/GST, Cr Customer)
  - Uses absolute values with flipped Dr/Cr (standard accounting practice)
  - Validated against Frappe Books, Tally, Zoho, QuickBooks
  - Dr = Cr validation enforced
- ✅ **Build Verification** - 36 pages compiled, 0 TypeScript errors
- ✅ **Credit Note Implementation** - Follows Frappe pattern (separate document with `is_credit_note` flag)
