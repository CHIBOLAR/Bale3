# Bale Inventory - Fabric Management System

## Project Overview

**Bale Inventory** is a Next.js-based fabric inventory management system targeting Indian textile traders. The application provides multi-tenant inventory tracking, sales order management, job work processing, and barcode-based stock tracking.

## Tech Stack

- **Frontend**: Next.js 15 (App Router) + TypeScript + Tailwind CSS
- **Database**: Supabase (PostgreSQL with Row Level Security)
- **Authentication**: Supabase Auth (JWT-based) + Google OAuth
- **Storage**: Supabase Storage for images/files
- **Deployment**: Hostinger + Supabase Cloud
- **Access Control**: Invite-only platform with platform and staff invites
- **Future Enhancement**: Rust + Axum backend (post-MVP)

## Commands

### Development
```bash
# Install dependencies
npm install

# Run development server (starts on http://localhost:3000)
npm run dev

# Build for production
npm run build

# Start production server
npm start

# Run linting
npm run lint

# Type checking
npx tsc --noEmit
```

### Supabase Local
```bash
# Start local Supabase (Docker required)
npx supabase start

# Stop local Supabase
npx supabase stop

# Reset database with migrations
npx supabase db reset

# Generate TypeScript types from database
npx supabase gen types typescript --local > types/database.ts

# Access Supabase Studio UI
# http://localhost:54323
```

### Supabase Production
```bash
# Login to Supabase
npx supabase login

# Link to production project
npx supabase link --project-ref YOUR_PROJECT_REF

# Push migrations to production
npx supabase db push

# Pull production schema
npx supabase db pull
```

### Git
```bash
# Check status
git status

# Commit changes
git add .
git commit -m "message"

# Push to GitHub
git push origin main
```

## Architecture

### Multi-Tenant Design
The system uses **company-based multi-tenancy** with Row Level Security:
- **Tenant = Company**: Complete data isolation between companies
- **Role-Based Access**: Admin (full access) vs Staff (warehouse-scoped)
- **Warehouse Scoping**: Staff can only access their assigned warehouse

### Entity Hierarchy
```
Company (Tenant)
â”œâ”€â”€ Users (Admin/Staff with warehouse assignment)
â”œâ”€â”€ Warehouses (multiple per company)
â”œâ”€â”€ Products (company-wide fabric specifications)
â”œâ”€â”€ Stock Units (physical fabric rolls in warehouses)
â”œâ”€â”€ Partners (Customers, Vendors, Suppliers, Agents)
â”œâ”€â”€ Sales Orders (customer orders with fulfillment tracking)
â”œâ”€â”€ Job Works (outsourced work: dyeing, printing, embroidery)
â”œâ”€â”€ Goods Dispatches (outward stock movement)
â””â”€â”€ Goods Receipts (inward stock movement)
```

### Access Control Matrix

| Feature | Admin | Staff |
|---------|-------|-------|
| Company Profile | Full CRUD | Read only |
| Warehouses | Full CRUD | No access |
| Users/Staff | Full CRUD | No access |
| Products | Full CRUD | Read only |
| Partners | Full CRUD | Read only |
| Stock Units | All warehouses | Assigned warehouse only |
| Goods Receipts | All warehouses | Assigned warehouse only |
| Goods Dispatches | All warehouses | Assigned warehouse only |
| Sales Orders | Full access | Assigned warehouse only |
| Job Works | All warehouses | Assigned warehouse only |
| Barcode Generation | All warehouses | Assigned warehouse only |
| Public Catalog Config | Full CRUD | No access |

### Database Security
All tables have **Row Level Security (RLS)** policies:
- **Company Isolation**: Users can only see data from their company
- **Warehouse Scoping**: Staff users can only access data from their assigned warehouse
- **Role Checks**: Admin role bypasses warehouse restrictions

### Key Business Logic

**Inventory Flow**:
- Stock can only be **added** via Goods Receipt
- Stock can only be **removed** via Goods Dispatch
- Stock status: `in_stock`, `reserved`, `dispatched`, `sold`

**Fabric-Specific Features**:
- Color management (name + hex code)
- GSM (fabric weight) tracking
- Material types (cotton, polyester, silk, blend, etc.)
- Quality grades (A, B, C, D)
- Measuring units (meters, yards, pieces, kg)

**Audit Trail**:
- All entities have: `created_at`, `updated_at`, `created_by`, `modified_by`, `deleted_at`
- Soft deletes for historical tracking

## Project Structure

```
/app
  /(auth)              # Authentication routes
    /login             # Login page
    /signup            # Company signup page
  /dashboard           # Protected dashboard
    /products          # Product management
    /inventory         # Goods receipts & stock units
    /sales             # Sales orders
    /partners          # Partner management
    /job-works         # Job work tracking
    /barcode           # Barcode generation
    /settings          # Company/warehouse/staff settings
  /catalog             # Public sales catalog
  /api                 # API routes
/components
  /layouts             # Layout components (DashboardNav, etc.)
  /ui                  # Reusable UI components
  /forms               # Form components
/lib
  /supabase
    /client.ts         # Browser Supabase client
    /server.ts         # Server Supabase client (with cookies)
  /utils               # Utility functions
  /validations         # Form validation schemas
/types                 # TypeScript type definitions
/supabase
  /migrations          # Database migration files (16 total)
/public                # Static assets
```

## Current Implementation Status

### âœ… Completed
- [x] Next.js 15 project setup with TypeScript and Tailwind CSS
- [x] Supabase local setup with Docker
- [x] Complete database schema (17 migrations including invite system)
- [x] Row Level Security policies
- [x] Authentication flow (signup/login)
- [x] Google OAuth integration (Sign in with Google)
- [x] Invite system (platform invites + staff invites)
- [x] Company onboarding (creates company + admin user + default warehouse)
- [x] Dashboard layout with navigation
- [x] Dashboard stats (products, stock, orders, partners count)
- [x] Middleware for route protection
- [x] Git repository initialized and pushed to GitHub
- [x] Hostinger deployment guide created
- [x] Google OAuth setup guide created
- [x] Invite system setup guide created

### ðŸš§ In Progress
- [ ] Products management page (CRUD operations)
- [ ] Inventory page (goods receipts)
- [ ] Sales orders page
- [ ] Partners management page

### ðŸ“‹ Pending
- [ ] Warehouses management (admin only)
- [ ] Staff management (admin only)
- [ ] Job works tracking
- [ ] Goods dispatch functionality
- [ ] Barcode generation and scanning
- [ ] Public sales catalog
- [ ] Settings pages
- [ ] Image upload functionality
- [ ] PDF generation for barcodes
- [ ] PWA configuration
- [ ] Mobile optimization

## Environment Variables

### Local Development (.env.local)
```env
NEXT_PUBLIC_SUPABASE_URL=http://127.0.0.1:54321
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_local_anon_key
SUPABASE_SERVICE_ROLE_KEY=your_local_service_role_key
GOOGLE_CLIENT_ID=your_google_client_id
GOOGLE_CLIENT_SECRET=your_google_client_secret
```

### Production (.env.production)
```env
NEXT_PUBLIC_SUPABASE_URL=https://your_project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_production_anon_key
SUPABASE_SERVICE_ROLE_KEY=your_production_service_role_key
GOOGLE_CLIENT_ID=your_google_client_id
GOOGLE_CLIENT_SECRET=your_google_client_secret
```

## Development Workflow

1. **Start Supabase**: `npx supabase start` (Docker must be running)
2. **Run Next.js**: `npm run dev`
3. **Access Application**: http://localhost:3000
4. **Access Supabase Studio**: http://localhost:54323
5. **Make Changes**: Edit code, database auto-reloads
6. **Commit Changes**: `git add . && git commit -m "message" && git push`

## Testing the Application

### Create Test Account (Platform Invite Required)
1. **Generate Platform Invite**:
   - Open Supabase Studio: http://localhost:54323
   - Run SQL: `SELECT create_platform_invite('email@example.com', 'YOUR_USER_ID'::uuid);`
   - Copy the returned invite code (12 characters)

2. **Sign Up**:
   - Go to http://localhost:3000/signup
   - Enter the invite code
   - Fill in company details and admin user details
   - Submit - creates company, user, and default warehouse
   - Redirects to dashboard

3. **Sign Up with Google** (Alternative):
   - Go to http://localhost:3000/signup
   - Click "Sign up with Google"
   - Authorize with your Google account
   - Auto-creates company, user, and default warehouse
   - Redirects to dashboard

### Test Authentication
1. Logout from dashboard
2. Go to http://localhost:3000/login
3. **Option A**: Login with email/password
4. **Option B**: Click "Sign in with Google"
5. Should redirect to dashboard with stats

### Verify Database
1. Open Supabase Studio: http://localhost:54323
2. Navigate to Table Editor
3. Check tables: companies, users, warehouses
4. Verify your test data exists

## Deployment

Refer to `DEPLOYMENT_GUIDE.md` for complete Hostinger deployment instructions.

### Quick Deployment Steps
1. Create production Supabase project
2. Run migrations: `npx supabase db push`
3. Update `.env.production` with production credentials
4. Build: `npm run build`
5. Upload to Hostinger via SSH or File Manager
6. Run with PM2: `pm2 start npm --name "bale-inventory" -- start`

## Troubleshooting

### Supabase Not Starting
```bash
# Check Docker status
docker ps

# Restart Docker and retry
npx supabase stop
npx supabase start
```

### Migration Errors
```bash
# Reset database completely
npx supabase db reset

# If circular dependency errors, check migration order
# Stock units migration should have nullable created_from_receipt_id
```

### Build Errors
```bash
# Clean and rebuild
rm -rf .next node_modules
npm install
npm run build
```

### Authentication Issues
- Check environment variables are set correctly
- Verify Supabase project is running
- Check browser console for errors
- Verify middleware.ts is configured correctly

## Resources

- **GitHub Repository**: https://github.com/CHIBOLAR/Bale3
- **Supabase Docs**: https://supabase.com/docs
- **Next.js Docs**: https://nextjs.org/docs
- **Deployment Guide**: See DEPLOYMENT_GUIDE.md
- **Project Plan**: See PROJECT_EXECUTION_PLAN.md
- **Google OAuth Setup**: See GOOGLE_OAUTH_SETUP.md
- **Invite System Setup**: See INVITE_SYSTEM_SETUP.md

## Support

For issues or questions:
1. Check existing documentation files
2. Review Supabase logs: `npx supabase status`
3. Check Next.js build errors: `npm run build`
4. Review application logs in browser console
